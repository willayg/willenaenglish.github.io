<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Input</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="/Teachers/tools/wordtest/style.css" />
  <link rel="stylesheet" href="./report-card.css" />
  <style>
    :root { --header-h: 64px; }
    body { background:#f5f7fb; }
    .header { position:sticky; top:0; z-index:1000; background:linear-gradient(135deg,#2563eb,#60a5fa); box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .header h1 { color:#fff; }
    .top-actions { position:sticky; top:var(--header-h); z-index:999; background:#e0f2fe; }
    .grid-wrap { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.06); }
    .toolbar { display:flex; gap:10px; padding:10px; align-items:center; border-bottom:1px solid #e5e7eb; background:#f8fafc; }
    .toolbar .spacer { flex:1; }
    .sheet { width:100%; overflow:auto; height:70vh; }
    table.grid { border-collapse: separate; border-spacing:0; width:max-content; min-width:100%; font-size:14px; }
    table.grid th, table.grid td { border:1px solid #e5e7eb; padding:6px 8px; min-width:90px; background:#fff; }
    table.grid th { position:sticky; top:0; background:#f8fafc; z-index:1; font-weight:700; }
    table.grid td[contenteditable="true"]:focus { outline:2px solid #60a5fa; }
    .id-col { position:sticky; left:0; background:#f8fafc; z-index:2; font-weight:600; }
  .sum-row { position:sticky; bottom:0; background:#f8fafc; font-weight:700; }
  /* Center align all dynamic score/grade columns (non id-col) */
  #gridBody td:not(.id-col), #gridHead th.col-head, #gridFoot td:not(.id-col) { text-align:center; }
  /* Keep name columns left-aligned */
  #gridBody td.id-col, #gridHead th.id-col, #gridFoot td.id-col { text-align:left; }
  /* Import preview alignment (first two columns = names) */
  #importPreview th:not(:first-child):not(:nth-child(2)),
  #importPreview td:not(:first-child):not(:nth-child(2)) { text-align:center; }
  #importPreview th:first-child, #importPreview th:nth-child(2),
  #importPreview td:first-child, #importPreview td:nth-child(2) { text-align:left; }
  #classCommentBox { margin:12px 10px 4px; display:flex; flex-direction:column; gap:4px; }
  #classComment { min-height:70px; font-size:13px; resize:vertical; }
    .pill { padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; display:inline-block; }
    .pill.meta { background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .note { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-card">
      <div class="header" style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <a href="/Teachers/tools/manage_students.html" class="layout-btn" style="background:#fff; color:#1e293b;">⟵ Back</a>
          <h1 style="margin:0;">Test Input</h1>
        </div>
        <div id="burger-menu-mount"></div>
      </div>
      <div class="top-actions" style="display:flex; gap:12px; align-items:center; padding:8px 10px;">
        <input id="search" class="input-field" placeholder="Search students" style="max-width:300px;" />
        <!-- Removed left class filter per feedback; class is chosen via the Load Test class switcher -->
  <!-- Month filter hidden per feedback; date will be automatic and tests recognized by name -->
  <input id="testMonthFilter" type="month" class="input-field" style="max-width:160px; display:none;" />
  <label for="testMonthFilter" style="font-size:12px; color:#4a5568; font-weight:500; display:none;">Month:</label>
        <div class="spacer" style="flex:1;"></div>
  <button id="newTestBtn" class="layout-btn">New Test</button>
        <select id="testClassFilter" class="toolbar-select"><option value="">All Classes</option></select>
        <select id="testPicker" class="toolbar-select"><option value="">Load Test…</option></select>
        <button id="refreshBtn" class="layout-btn">Refresh</button>
  <button id="openReportCardsBtn" class="layout-btn">Report Cards</button>
      </div>

      <div class="grid-wrap">
        <div class="toolbar">
          <span class="pill meta" id="testMeta">No test loaded</span>
          <input id="testName" class="input-field" placeholder="Test name (e.g., Brown Midterm)" style="max-width:280px;" />
          <input id="testDate" class="input-field" type="date" />
          <span id="computedIndicator" class="pill meta" title="Toggle via right-click menu on the grid header">Computed: Locked</span>
          <div class="spacer"></div>
          <button id="addColumnBtn" class="layout-btn">+ Column</button>
          <button id="importTableBtn" class="layout-btn">Import from Table</button>
          <button id="saveBtn" class="extract-btn">Save</button>
          <button id="exportCsvBtn" class="layout-btn">Export CSV</button>
        </div>
        <div class="sheet">
          <table class="grid" id="grid">
            <thead id="gridHead"></thead>
            <tbody id="gridBody"></tbody>
            <tfoot id="gridFoot"></tfoot>
          </table>
          <div id="classCommentBox">
            <label for="classComment" class="note" style="font-weight:600; margin-top:8px; display:block;">Class Comment (appears on each report card)</label>
            <textarea id="classComment" class="input-field" style="margin-top:4px;" placeholder="Enter class comment..."></textarea>
          </div>
        </div>
        <div id="msg" class="note" style="padding:8px 10px;"></div>
      </div>
    </div>
  </div>

  <!-- Context menu for grid actions -->
  <div id="gridMenu" style="display:none; position:fixed; z-index:2000; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); min-width:180px; overflow:hidden;">
    <div data-act="copy" style="padding:8px 12px; cursor:pointer;">Copy</div>
    <div data-act="paste" style="padding:8px 12px; cursor:pointer;">Paste</div>
    <div data-act="delete" style="padding:8px 12px; cursor:pointer;">Delete</div>
    <div data-act="filldown" style="padding:8px 12px; cursor:pointer;">Fill down</div>
    <hr style="margin:6px 0; border:none; border-top:1px solid #e5e7eb;" />
    <div data-act="toggle-computed" style="padding:8px 12px; cursor:pointer;">Unlock/Lock computed</div>
  </div>
  <!-- Column header context menu -->
  <div id="colMenu" style="display:none; position:fixed; z-index:2001; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); min-width:200px; overflow:hidden;">
    <div data-act="rename" style="padding:8px 12px; cursor:pointer;">Rename column</div>
    <div data-act="setmax" style="padding:8px 12px; cursor:pointer;">Set max (numbers)</div>
    <div data-act="moveleft" style="padding:8px 12px; cursor:pointer;">Move left</div>
    <div data-act="moveright" style="padding:8px 12px; cursor:pointer;">Move right</div>
    <div data-act="delete" style="padding:8px 12px; cursor:pointer; color:#b91c1c;">Delete column</div>
  </div>

  <script type="module">
    import { insertBurgerMenu } from '/Teachers/components/burger-menu.js';
    async function ensureBurgerMenuTemplate() {
      if (!document.getElementById('burger-menu-template')) {
        const resp = await fetch('/Teachers/components/burger-menu.html');
        const html = await resp.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        document.body.appendChild(tempDiv.firstElementChild);
      }
    }
    await ensureBurgerMenuTemplate();
    insertBurgerMenu('#burger-menu-mount');
  </script>
  <script type="module" src="./test_input.js"></script>
  <style>
    /* Selection styling */
    td.cell-selected { outline:2px solid #60a5fa; background:#eff6ff; }
    #gridMenu div:hover { background:#f1f5f9; }
    #colMenu div:hover { background:#f1f5f9; }
  </style>

  <!-- Create Campaign Modal -->
  <div id="campaignModalBg" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.35); z-index:3000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:96vw; max-width:640px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:16px 16px 12px;">
      <h3 style="margin:4px 0 10px;">Create Test for Classes</h3>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
        <input id="campaignName" class="input-field" placeholder="Test name (e.g., October 2025 Test)" style="flex:1;" />
        <input id="campaignDate" type="date" class="input-field" />
      </div>
      <div class="note" style="margin-bottom:8px;">Select classes to include. You can edit maxima per class after creating.</div>
      <div id="campaignClassList" style="max-height:40vh; overflow:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:8px; padding:6px; border:1px solid #e5e7eb; border-radius:8px;"></div>
      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:10px;">
        <div>
          <button id="campaignSelectAll" class="layout-btn">Select All</button>
          <button id="campaignClear" class="clear-btn">Clear</button>
        </div>
        <div>
          <button id="campaignCancel" class="clear-btn">Cancel</button>
          <button id="campaignCreate" class="extract-btn">Create</button>
        </div>
      </div>
      <div id="campaignMsg" class="note" style="margin-top:6px;"></div>
    </div>
  </div>

  <!-- Import From Table Modal -->
  <div id="importModalBg" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.35); z-index:3001; align-items:center; justify-content:center;">
    <div style="background:#fff; width:min(96vw, 980px); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:16px 16px 12px; display:flex; flex-direction:column; gap:10px; position:relative;">
      <button id="importCloseX" style="position:absolute; top:6px; right:8px; background:none; border:none; font-size:20px; line-height:1; cursor:pointer; color:#475569;" aria-label="Close import">&times;</button>
      <h3 style="margin:4px 24px 6px 0;">Import Scores from Pasted Table</h3>
      <div class="note">Paste the table exactly as copied from your sheet (with headers). We'll detect classes, columns, and scores automatically. You can adjust the test name and date before import.</div>
      <div style="display:grid; grid-template-columns: 1fr 320px; gap:12px; align-items:stretch;">
        <textarea id="pasteTableInput" class="input-field" placeholder="Paste table here..." style="height:260px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <input id="importTestName" class="input-field" placeholder="Test name (e.g., October 2025 Test)" />
          <input id="importTestDate" type="date" class="input-field" />
          <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:#334155;"><input id="perClassSwitch" type="checkbox" checked /> Create one test per class</label>
          <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:#334155;"><input id="strictTsvSwitch" type="checkbox" /> Strict TSV (preserve blanks)</label>
          <div id="importSummary" class="note" style="min-height:120px; padding:8px; border:1px solid #e5e7eb; border-radius:8px; background:#f8fafc; overflow:auto;"></div>
          <div style="display:flex; gap:8px; margin-top:auto; justify-content:flex-end;">
            <button id="importCancel" class="clear-btn">Cancel</button>
            <button id="importParse" class="layout-btn">Parse</button>
            <button id="importConfirm" class="extract-btn" disabled>Import & Save</button>
          </div>
        </div>
      </div>
      <div id="importPreviewWrap" style="max-height:260px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; display:none;">
        <table id="importPreview" class="grid" style="width:100%; border-collapse:separate; border-spacing:0; font-size:13px;"></table>
      </div>
      <div id="importMsg" class="note"></div>
    </div>
  </div>

  <!-- Report Cards Modal -->
  <div id="rcModalBg" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.35); z-index:3002; align-items:center; justify-content:center;">
    <div id="rcModal" style="background:#fff; width:min(96vw, 1100px); max-height:92vh; overflow:auto; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
      <div style="position:sticky; top:0; background:#f8fafc; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; z-index:1;">
        <div style="display:flex; align-items:center; gap:10px;">
          <strong>Report Cards</strong>
          <span id="rcStatus" class="note"></span>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="rcPrintBtn" class="extract-btn">Print</button>
          <button id="rcCloseBtn" class="clear-btn">Close</button>
        </div>
      </div>
      <div id="rcCardsWrap" style="padding:14px;">
        <div id="rcCardsContainer"></div>
      </div>
    </div>
  </div>
  
</body>
</html>
