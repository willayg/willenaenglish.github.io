<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Worksheet Generator</title>
    <link rel="stylesheet" href="../tests/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Caveat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .floating-toolbar {
          background: #f8c080 !important;
          border-color: #d8973c !important;
        }
        /* Make preview area larger and more readable */
        .preview-area {
          min-width: 500px;
          width: 100%;
          min-height: 600px;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.07);
          margin: 0 0 0 24px;
          padding: 32px 32px 32px 32px;
          overflow: auto;
          display: flex;
          flex-direction: column;
          align-items: center;
        }
        /* A4 worksheet sizing for preview and print */
        .a4-sheet {
          width: 794px; /* A4 width at 96dpi */
          min-height: 1123px; /* A4 height at 96dpi */
          max-width: 100%;
          margin: 0 auto;
          background: #fff;
          box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        /* Print styles removed - now handled by print.js */
        /* Two-column worksheet layout */
        .two-column {
          column-count: 2;
          column-gap: 40px;
          column-fill: balance;
          height: auto;
        }
        /* Prevent header and answer key from being split by columns */
        .worksheet-header, .answer-key-section {
          column-span: all;
          break-inside: avoid;
        }
        /* Make sure section boxes don't break across columns */
        .section-box, .grammar-questions {
          break-inside: avoid;
          page-break-inside: avoid;
          margin-bottom: 15px;
        }
        .preview-area .preview-placeholder {
          color: #aaa;
          text-align: center;
          margin-top: 100px;
        }
        /* Worksheet section box styles */
        .section-box.design-0 {
          background: #fffbe7;
          border: 2px solid #ffe08a;
          box-shadow: 0 2px 8px rgba(255, 224, 138, 0.12);
        }
        .section-box.design-1 {
          background: #f0f7ff;
          border: 2px solid #a3d1ff;
          box-shadow: 0 2px 8px rgba(163, 209, 255, 0.12);
        }
        .section-box.design-2 {
          background: #f9f6ff;
          border: 2px solid #c7bfff;
          box-shadow: 0 2px 8px rgba(199, 191, 255, 0.12);
        }
        .section-box {
          width: 100%;
          box-sizing: border-box;
          border-radius: 8px;
          margin-bottom: 24px;
          padding: 24px 20px 20px 20px;
          display: block;
        }
        /* New: line between sections for design-4 */
        .line-section {
          border-bottom: 2px solid #bdbdbd;
          margin-bottom: 24px;
          padding-bottom: 18px;
        }
        .grammar-questions {
          white-space: pre-line;
          margin-bottom: 16px;
          line-height: 2.1;
          font-size: 1em;
        }
        /* All worksheet headers have a simple line */
        .design-0 .worksheet-header,
        .design-1 .worksheet-header,
        .design-2 .worksheet-header,
        .design-3 .worksheet-header,
        .design-4 .worksheet-header {
          border-bottom: 2px solid #d3d3d3;
          padding-bottom: 12px;
          margin-bottom: 18px !important;
        }
        .design-3 {
          background: #fff;
          border: none;
          box-shadow: none;
        }
        /* Design-4: no box, just lines between sections */
        .design-4 {
          background: #fff;
          border: none;
          box-shadow: none;
        }
    </style>
</head>
<body>
  <script>
    // Access control: only allow approved users
    (async function() {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        window.location.href = '/Teachers/login.html';
        return;
      }
      try {
        const res = await fetch('/.netlify/functions/supabase_proxy_fixed?action=get_profile&user_id=' + encodeURIComponent(userId));
        const result = await res.json();
        if (!result.success || result.approved !== true) {
          window.location.href = '/Teachers/components/access-denied.html';
          return;
        }
      } catch (e) {
        window.location.href = '/Teachers/login.html';
      }
    })();
  </script>
    <!-- Load shared burger menu component -->
    <script type="module">
      import { insertBurgerMenu } from '/Teachers/components/burger-menu.js';
      async function ensureBurgerMenuTemplate() {
        if (!document.getElementById('burger-menu-template')) {
          const resp = await fetch('/Teachers/components/burger-menu.html');
          const html = await resp.text();
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          document.body.appendChild(tempDiv.firstElementChild);
        }
      }
      document.addEventListener('DOMContentLoaded', async function() {
        await ensureBurgerMenuTemplate();
        insertBurgerMenu('#burger-menu-mount');
      });
    </script>
    <script>
    // Feedback modal loader for Grammar Worksheet Generator
    window.showFeedbackModal = async function() {
      if (!document.getElementById('feedback-modal')) {
        const resp = await fetch('/Teachers/components/feedback-modal.html');
        const html = await resp.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        document.body.appendChild(tempDiv.firstElementChild);
      }
      const modal = document.getElementById('feedback-modal');
      if (!modal) return;
      modal.style.display = 'block';
      const closeBtn = modal.querySelector('.close');
      if (closeBtn) {
        closeBtn.onclick = () => { modal.style.display = 'none'; };
      }
      window.onclick = function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      };
      const submitBtn = modal.querySelector('#feedback-submit');
      if (submitBtn) {
        submitBtn.onclick = async function() {
          const feedbackText = modal.querySelector('#feedback-text').value;
          // Collect grammar worksheet state
          const state = {
            title: document.getElementById('grammarTitle')?.value || '',
            instructions: document.getElementById('grammarInstructions')?.value || '',
            questions: document.getElementById('grammarQuestions')?.value || '',
            answers: document.getElementById('grammarAnswers')?.value || '',
            font: document.getElementById('fontSelect')?.value || '',
            fontSize: document.getElementById('fontSizeInput')?.value || '',
            template: document.getElementById('templateSelect')?.value || '',
            layout: document.getElementById('layoutSelect')?.value || '',
            numQuestions: document.getElementById('numQuestions')?.value || '',
            questionType: document.getElementById('questionTypeSelect')?.value || ''
          };
          if (window.feedbackSubmitToSupabase) {
            await window.feedbackSubmitToSupabase({
              module: 'grammar',
              feedback: feedbackText,
              state
            });
          }
          modal.style.display = 'none';
          modal.querySelector('#feedback-text').value = '';
          alert('Thank you for your feedback!');
        };
      }
    };
    </script>
    <div class="container">
        <div class="app-card">
            <!-- Header -->
            <div class="header" style="position:relative; z-index:100; min-height:64px; display:flex; align-items:center;">
                <div class="logo">
                    <img src="../../../Assets/Images/Logo.png" alt="Willena" class="logo-img">
                </div>
                <h1 style="flex:1; text-align:center; margin:0;">Grammar Worksheet Generator</h1>
                <div id="burger-menu-mount" style="position:absolute; top:50%; right:16px; transform:translateY(-50%); z-index:9999;"></div>
            </div>
            <!-- Top Action Bar -->
            <div class="top-actions">
                <span class="action-link" id="loadBtn">Load</span>
                <span class="action-link" id="saveBtn">Save</span>
                <span class="action-link" id="printBtn">Print</span>
                <span class="action-link" id="pdfBtn">PDF</span>
            </div>
            <!-- Floating Toolbar -->
            <div class="floating-toolbar" id="floatingToolbar">
                <select class="toolbar-select" id="fontSelect">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Calibri">Calibri</option>
                    <option value="Poppins">Poppins</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Garamond">Garamond</option>
                    <option value="Comic Sans MS">Comic Sans MS</option>
                    <option value="Caveat">Caveat (Handwriting)</option>
                </select>
                <div class="font-size-controls">
                    <button class="size-btn" id="decreaseFontBtn">-</button>
                    <input type="number" class="font-size-input" id="fontSizeInput" value="12" min="8" max="18" step="1">
                    <button class="size-btn" id="increaseFontBtn">+</button>
                </div>
                <select class="toolbar-select" id="templateSelect">
                    <option value="0">Design 1 (Yellow Box)</option>
                    <option value="1">Design 2 (Blue Box)</option>
                    <option value="2">Design 3 (Purple Box)</option>
                    <option value="3">Design 4 (Simple Line)</option>
                    <option value="4">Design 5 (Lines Between Parts)</option>
                </select>
                <div class="layout-group">
                    <select class="layout-select" id="layoutSelect">
                        <option value="default">Standard Layout</option>
                        <option value="two-column">Two Column</option>
                        <option value="large-text">Large Text</option>
                    </select>
                </div>
                <button class="refresh-btn" id="refreshBtn" title="Refresh Preview">↻</button>
            </div>
            <!-- Main Content -->
            <div class="main-content">
                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Title at the top of the toolbar -->
                    <div class="input-group">
                        <label>Title</label>
                        <input type="text" class="input-field" id="grammarTitle" placeholder="Enter worksheet title">
                    </div>
                    <!-- Flexible AI Prompt for Grammar Worksheet Generation -->
                    <div class="input-group" id="aiPromptGroup">
                        <label for="aiPromptInput" style="font-size:13px; color:#444; font-weight:500;">Free Style Prompt (describe grammar point, give examples, or instructions to the AI)</label>
                        <textarea id="aiPromptInput" class="textarea-field" rows="3" placeholder="e.g. Make 10 questions using the present perfect. Or: Give me 5 error correction sentences about articles."></textarea>
                        <button id="sendAIPromptBtn" class="extract-btn" style="margin-top:8px;">Send Prompt to AI</button>
                    </div>
    <!-- AI prompt handler for grammar worksheet (moved out of sidebar for valid HTML) -->
    <script type="module">
      import { showGrammarSectionModal, addGrammarSection } from './grammar-section-modal.js';
      let grammarSections = [];
      window.grammarSections = grammarSections;
      document.addEventListener('DOMContentLoaded', function() {
        const aiBtn = document.getElementById('sendAIPromptBtn');
        const aiInput = document.getElementById('aiPromptInput');
        if (aiBtn && aiInput) {
          aiBtn.addEventListener('click', async function() {
            const prompt = aiInput.value.trim();
            if (!prompt) {
              aiInput.focus();
              return;
            }
            aiBtn.disabled = true;
            aiBtn.textContent = 'Thinking...';
            try {
              const res = await fetch('/.netlify/functions/openai_proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, type: 'grammar' })
              });
              const data = await res.json();
              if (data && data.result) {
                showGrammarSectionModal(data.result.trim(), function(editedQuestions) {
                  grammarSections.push(editedQuestions);
                  updateGrammarPreview();
                });
              } else {
                alert('AI did not return any questions.');
              }
            } catch (e) {
              alert('Error contacting AI: ' + (e.message || e));
            } finally {
              aiBtn.disabled = false;
              aiBtn.textContent = 'Send Prompt to AI';
            }
          });
        }
      });
      // Expose for preview update script
      window.addGrammarSection = addGrammarSection;
    </script>
                    <div class="input-group">
                        <label>Question Type</label>
                        <select class="select-field" id="questionTypeSelect">
                            <option value="fill-blank">Fill in the Blank</option>
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="error-correction">Error Correction</option>
                            <option value="short-answer">Short Answer</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Number of Questions</label>
                        <input type="number" class="number-input" id="numQuestions" value="5" min="1" max="20">
                    </div>
                    <div class="button-group">
                        <button class="extract-btn" id="generateQuestionsBtn">Generate Questions</button>
                        <button class="clear-btn" id="clearBtn">Clear All</button>
                    </div>
                    <script>
                    // Fix Clear All button to clear all fields and preview
                    document.addEventListener('DOMContentLoaded', function() {
                      const clearBtn = document.getElementById('clearBtn');
                      if (clearBtn) {
                        clearBtn.addEventListener('click', function() {
                          document.getElementById('grammarTitle').value = '';
                          document.getElementById('aiPromptInput').value = '';
                          document.getElementById('grammarQuestions').value = '';
                          document.getElementById('grammarAnswers').value = '';
                          window.grammarSections = [];
                          if (typeof window.updateGrammarPreview === 'function') window.updateGrammarPreview();
                        });
                      }
                    });
                    </script>
                    <div class="input-group">
                        <label>Questions</label>
                        <textarea class="textarea-field" id="grammarQuestions" placeholder="Generated questions will appear here, or type your own..." rows="8"></textarea>
                        <div class="button-group" style="margin-top: 8px;">
                            <button class="extract-btn" id="addSectionBreakBtn">Add New Part</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Answer Key</label>
                        <textarea class="textarea-field" id="grammarAnswers" placeholder="Answer key will appear here..." rows="4"></textarea>
                        <div class="button-group" style="margin-top: 8px;">
                            <button class="extract-btn" id="printAnswerKeyBtn" type="button">Print Answer Key</button>
                        </div>
                    </div>
                </div>
                <!-- Preview Area -->
                <div class="preview-area" id="worksheetPreviewArea-grammar">
                    <div class="preview-placeholder" id="grammarPreviewPlaceholder">
                        <p>Preview will appear here</p>
                    </div>
                </div>
                <script>
                // Make preview content editable on left click and allow right-click to delete a section
                document.addEventListener('DOMContentLoaded', function() {
                  const preview = document.getElementById('worksheetPreviewArea-grammar');
                  if (preview) {
                    preview.addEventListener('click', function(e) {
                      // Only enable editing if not already editable
                      if (!preview.isContentEditable) {
                        preview.contentEditable = 'true';
                        preview.focus();
                      }
                    });
                    // Right-click to delete a section
                    preview.addEventListener('contextmenu', function(e) {
                      // Find the closest section-box or grammar-questions div
                      let section = e.target.closest('.section-box, .grammar-questions');
                      if (section && preview.contains(section)) {
                        e.preventDefault();
                        section.remove();
                      }
                    });
                  }
                });
                </script>
                </div>
            </div>
        </div>
    </div>
    <!-- Grammar worksheet logic -->
    <script type="module" src="./grammar.js"></script>
    <!-- AI prompt logic for grammar worksheet generation -->
    <script type="module" src="./ai.js"></script>
    <!-- Section modal logic for grammar worksheet generation -->
    <script type="module" src="./grammar-section-modal.js"></script>
    <!-- Print logic for clean worksheet printing -->
    <script src="./print.js"></script>
    <script>
    // Grammar worksheet preview function has been replaced with createGrammarPreview

    // Create a simple preview update function to create a two-column layout
    function createGrammarPreview() {
      // Get all values
      const title = document.getElementById('grammarTitle')?.value || '';
      const instructions = document.getElementById('grammarInstructions')?.value || '';
      const answers = document.getElementById('grammarAnswers')?.value || '';
      const font = document.getElementById('fontSelect')?.value || 'Poppins';
      const fontSize = document.getElementById('fontSizeInput')?.value || '12';
      const template = document.getElementById('templateSelect')?.value || '0';
      const layout = document.getElementById('layoutSelect')?.value || 'default';
      
      // Get design classes
      let designClass = 'design-0';
      if (template === '1') designClass = 'design-1';
      else if (template === '2') designClass = 'design-2';
      else if (template === '3') designClass = 'design-3';
      else if (template === '4') designClass = 'design-4';
      
      // Get layout class
      let layoutClass = '';
      if (layout === 'two-column') layoutClass = 'two-column';
      
      // Build sections HTML
      let sectionsHtml = '';
      let grammarSections = window.grammarSections || [];
      let addGrammarSection = window.addGrammarSection;
      if (grammarSections.length > 0 && typeof addGrammarSection === 'function') {
        grammarSections.forEach(function(questions, idx) {
          sectionsHtml += addGrammarSection(questions, idx);
        });
      } else {
        // fallback to single questions textarea
        const questions = document.getElementById('grammarQuestions')?.value || '';
        sectionsHtml = '<div class="grammar-questions">' + (questions || '<i>No questions yet.</i>') + '</div>';
      }
      
      // Create HTML
      let html = '<div class="' + designClass + ' a4-sheet" style="width:100%;padding:24px;box-sizing:border-box;font-family:' + font + ',sans-serif;font-size:' + fontSize + 'px;">';
      
      // Add header
      html += '<div class="worksheet-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">';
      html += '<img src="../../../Assets/Images/color-logo1.png" alt="Willena Logo" style="width:60px;max-width:80px;">';
      html += '<div style="flex:1;text-align:center;">';
      html += '<h1 style="font-size:2.4em;margin:0 0 5px 0;color:#2e2b3f;font-family:' + font + ',sans-serif;">' + (title || 'Grammar Worksheet') + '</h1>';
      html += '<div style="display:flex;justify-content:space-between;margin:0 30px 0 30px;font-size:1em;">';
      html += '<span>Name: ________________</span>';
      html += '<span>Date: ________________</span>';
      html += '</div></div></div>';
      
      // Add instructions if present
      if (instructions) {
        html += '<div style="margin-bottom:10px;"><b>Instructions:</b> ' + instructions + '</div>';
      }
      
      // Add content section with two-column if selected
      if (layout === 'two-column') {
        html += '<div class="' + layoutClass + '" style="width:100%;">' + sectionsHtml + '</div>';
      } else {
        html += '<div>' + sectionsHtml + '</div>';
      }
      
      // Add answer key
      html += '<div class="answer-key-section" style="margin-top:18px;"><b>Answer Key:</b>';
      html += '<div style="white-space:pre-line;">' + (answers || '<i>No answer key yet.</i>') + '</div></div>';
      
      // Close container
      html += '</div>';
      
      // Update preview
      const preview = document.getElementById('worksheetPreviewArea-grammar');
      if (preview) {
        preview.innerHTML = html;
      }
    }

    // Hook up preview updates to all relevant fields and font size buttons
    document.addEventListener('DOMContentLoaded', function() {
      const ids = [
        'grammarTitle',
        'grammarInstructions',
        'grammarQuestions',
        'grammarAnswers',
        'fontSelect',
        'fontSizeInput',
        'templateSelect',
        'layoutSelect'
      ];
      ids.forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', createGrammarPreview);
          el.addEventListener('change', createGrammarPreview);
        }
      });

      // Font size + and - buttons
      const fontSizeInput = document.getElementById('fontSizeInput');
      const increaseBtn = document.getElementById('increaseFontBtn');
      const decreaseBtn = document.getElementById('decreaseFontBtn');
      if (increaseBtn && fontSizeInput) {
        increaseBtn.addEventListener('click', function() {
          let val = parseInt(fontSizeInput.value, 10) || 12;
          if (val < parseInt(fontSizeInput.max || '18', 10)) {
            fontSizeInput.value = val + 1;
            fontSizeInput.dispatchEvent(new Event('input'));
          }
        });
      }
      if (decreaseBtn && fontSizeInput) {
        decreaseBtn.addEventListener('click', function() {
          let val = parseInt(fontSizeInput.value, 10) || 12;
          if (val > parseInt(fontSizeInput.min || '8', 10)) {
            fontSizeInput.value = val - 1;
            fontSizeInput.dispatchEvent(new Event('input'));
          }
        });
      }

      createGrammarPreview();
      window.updateGrammarPreview = createGrammarPreview;
      
      // Print button functionality
      const printBtn = document.getElementById('printBtn');
      if (printBtn) {
        printBtn.addEventListener('click', function() {
          if (window.printWorksheet) {
            window.printWorksheet();
          } else {
            window.print(); // fallback
          }
        });
      }
    });
    </script>
</body>
</html>
