<!DOCTYPE html>
<html>
<head>
  <title>B2 File Manager</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input[type="file"] { margin-bottom: 10px; }
    .file-list { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>B2 File Manager</h2>

  <input type="file" id="fileInput" />
  <button onclick="uploadFile()">Upload</button>
  <button onclick="listFiles()">Refresh List</button>

  <div class="file-list" id="fileList"></div>

  <script>
    const proxyUrl = "/.netlify/functions/b2_proxy";

    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Choose a file first.");

      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(',')[1];

        const res = await fetch(proxyUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filename: file.name,
            base64: base64,
          }),
        });

        const data = await res.json();
        alert(data.message || "Upload complete.");
        listFiles();
      };

      reader.readAsDataURL(file);
    }

    async function listFiles() {
      const res = await fetch(proxyUrl);
      const data = await res.json();
      const list = document.getElementById("fileList");
      list.innerHTML = "<h3>Files:</h3>";

      if (!data.files || data.files.length === 0) {
        list.innerHTML += "<p>No files found.</p>";
        return;
      }

      const ul = document.createElement("ul");
      data.files.forEach(file => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="${file.url}" target="_blank">${file.key}</a> (${Math.round(file.size / 1024)} KB)`;
        ul.appendChild(li);
      });
      list.appendChild(ul);
    }

    // Load files on page load
    window.onload = listFiles;
  </script>
</body>
</html>
