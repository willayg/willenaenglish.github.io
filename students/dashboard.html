<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/students/dashboard.css" />
  <link rel="stylesheet" href="/students/theme.css" />
  <base href="/students/">
  <meta name="robots" content="noindex" />
  <!-- API config -->
  <script src="/js/api-config.js"></script>
  <script>
    // Redirect to login if not signed in
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Check if cookies are actually blocked (try to set/read a test cookie)
        let cookiesBlocked = false;
        try {
          document.cookie = '__cookie_test=1; Path=/; SameSite=Lax';
          cookiesBlocked = !document.cookie.includes('__cookie_test=1');
          // Clean up test cookie
          document.cookie = '__cookie_test=; Path=/; Max-Age=0';
        } catch (e) {
          cookiesBlocked = true;
        }

        if (cookiesBlocked) {
          // Show a lightweight banner instructing user to allow cookies or use normal browsing mode
          const b = document.createElement('div');
          b.style.position = 'fixed';
          b.style.left = '0';
          b.style.right = '0';
          b.style.top = '0';
          b.style.zIndex = '99999';
          b.style.background = '#ffe9e6';
          b.style.color = '#2b0b09';
          b.style.padding = '12px 16px';
          b.style.fontWeight = '700';
          b.style.textAlign = 'center';
          b.textContent = 'Cookies appear to be blocked in this browser window. Please enable cookies or open the site in a regular (non-incognito) window so you can sign in.';
          const closeBtn = document.createElement('button');
          closeBtn.textContent = 'Close';
          closeBtn.style.marginLeft = '12px';
          closeBtn.addEventListener('click', () => b.remove());
          b.appendChild(closeBtn);
          document.body.appendChild(b);
          return; // stop further checks to avoid lots of 401s
        }

        const who = await WillenaAPI.fetch(`/api/supabase_auth?action=whoami&_=${Date.now()}`);
        console.log('[Dashboard] Auth check response:', who.status, who.statusText);
        const w = await who.json();
        console.log('[Dashboard] Auth data:', w);
        if (!w.success) {
          console.log('[Dashboard] Not logged in, redirecting to signin');
          // Not logged in - redirect to login
          location.replace('/students/signin.html?next=' + encodeURIComponent(location.pathname));
        } else {
          console.log('[Dashboard] User is logged in:', w.user_id || w.id);
        }
      } catch (err) {
        // If auth check fails (network error, JSON parse error, etc.), redirect to login
        console.error('[Dashboard] Auth check error:', err);
        location.replace('/students/login.html?next=' + encodeURIComponent(location.pathname));
      }
    });
  </script>
  <script type="module" src="/students/components/student-header.js"></script>
  <script src="/students/language.js"></script>
  <script src="/students/theme.js"></script>
</head>
<body>
  <student-header title="Welcome" show-id="false" show-home="false" show-points="true" data-i18n="Welcome"></student-header>
  <div class="wrap">
    <div class="cards masonry">
      <!-- Start Playing -->
      <section class="card">
        <div class="card-content" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 80px 15px; padding: 12px; height: auto; border: none; background: transparent;">
          <!-- English Arcade (merged with Grammar) -->
          <a href="/Games/english_arcade/index.html" class="wa-option-card wa-word-arcade" style="text-decoration: none; color: inherit; background: #343d44; border: 3px solid #59d7db; border-radius: 16px; padding: 24px 12px 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; transition: transform .25s cubic-bezier(.4,2,.3,.7), box-shadow .25s ease, border-color .25s ease; cursor: pointer; grid-column: span 2; min-height: 200px;">
            <img src="/Games/english_arcade/assets/Images/icons/english-arcade.svg" alt="English Arcade" style="width: 250px; height: 100px; max-width: none; object-fit: contain;">
            <div style="text-align: center; font-size: 1.6rem; font-weight: 700; letter-spacing: .3px; color: white; text-shadow: 0 0 10px #00ffff, 0 0 20px rgba(0,255,255,0.6);" data-i18n="Start Game">Start Game</div>
          </a>
        </div>
      </section>

      <!-- Your Work -->
      

      <!-- Class Leaderboard -->
      <!-- Stars Leaderboard (appears above points-based class leaderboard) -->
      <!-- Stars Class Leaderboard -->
      <section class="card" id="starsLeaderboardCard">
        <h2 class="card-title" data-i18n="Class Leaders">Class Leaders</h2>
        <div id="starsClassNameDisplay" style="font-size:1.1rem;font-weight:500;color:#67e2e6;text-align:center;margin-top:4px;margin-bottom:12px;text-shadow:0 0 10px rgba(103,226,230,0.4);"></div>
        <div class="lb-tabs" id="starsLeaderboardTabs" role="tablist">
          <button id="slTabSuper" class="lb-tab active" type="button" role="tab" aria-selected="true" data-metric="super" data-i18n="Super Score">Super Score</button>
          <button id="slTabStars" class="lb-tab" type="button" role="tab" aria-selected="false" data-metric="stars" data-i18n="Stars">Stars</button>
          <button id="slTabPoints" class="lb-tab" type="button" role="tab" aria-selected="false" data-metric="points" data-i18n="Points">Points</button>
        </div>
        <div id="starsLeaderboardFilters" style="margin-top:8px;margin-bottom:12px;display:flex;justify-content:center;gap:16px;align-items:center;">
          <button id="slFilterMonth" class="sl-filter-btn active" type="button" aria-pressed="true" data-i18n="This Month">This Month</button>
          <button id="slFilterAll" class="sl-filter-btn" type="button" aria-pressed="false" data-i18n="All Time">All Time</button>
          <button id="slRefreshBtn" type="button" title="Refresh" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;opacity:0.6;transition:opacity 0.2s,transform 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6"><span class="material-icons" style="font-size:20px;color:#67e2e6;">refresh</span></button>
          <span id="starsSmallSpinner" class="mini-lb-spinner hidden" aria-hidden="true" title="Loading"></span>
        </div>
        <div class="card-content" id="starsLeaderboardContent" style="min-height:120px;">
          <div class="lb-loading">
            <div class="lb-spinner" aria-hidden="true"></div>
            <div class="lb-loading-text" data-i18n="Loading leaderboard">Loading leaderboard</div>
            <ul class="lb-skeleton-list" aria-hidden="true">
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Global Leaderboard -->
      <section class="card" id="globalLeaderboardCard">
        <h2 class="card-title" data-i18n="Willena Leaders">Willena Leaders</h2>
        <div class="lb-tabs" id="globalLeaderboardTabs" role="tablist">
          <button id="glTabSuper" class="lb-tab active" type="button" role="tab" aria-selected="true" data-metric="super" data-i18n="Super Score">Super Score</button>
          <button id="glTabStars" class="lb-tab" type="button" role="tab" aria-selected="false" data-metric="stars" data-i18n="Stars">Stars</button>
          <button id="glTabPoints" class="lb-tab" type="button" role="tab" aria-selected="false" data-metric="points" data-i18n="Points">Points</button>
        </div>
        <div id="globalLeaderboardFilters" style="margin-top:8px;margin-bottom:12px;display:flex;justify-content:center;gap:16px;align-items:center;">
          <button id="glFilterMonth" class="gl-filter-btn active" type="button" aria-pressed="true" data-i18n="This Month">This Month</button>
          <button id="glFilterAll" class="gl-filter-btn" type="button" aria-pressed="false" data-i18n="All Time">All Time</button>
          <button id="glRefreshBtn" type="button" title="Refresh" style="background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;opacity:0.6;transition:opacity 0.2s,transform 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6"><span class="material-icons" style="font-size:20px;color:#67e2e6;">refresh</span></button>
          <span id="globalSmallSpinner" class="mini-lb-spinner hidden" aria-hidden="true" title="Loading"></span>
        </div>
        <div class="card-content" id="globalLeaderboardContent" style="min-height:120px;">
          <div class="lb-loading">
            <div class="lb-spinner" aria-hidden="true"></div>
            <div class="lb-loading-text" data-i18n="Loading leaderboard">Loading leaderboard</div>
            <ul class="lb-skeleton-list" aria-hidden="true">
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
              <li class="lb-skel-item"><div class="lb-skel-rank"></div><div class="lb-skel-text"></div><div class="lb-skel-score"></div></li>
            </ul>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title" data-i18n="Account">Account</h2>
        <div class="card-content">
          <div class="account-list">
            <a href="#" id="changePasswordLink" class="account-link" data-i18n="Change Password">Change Password</a>
            <a href="#" id="changeEmailLink" class="account-link" data-i18n="Change Email">Change Email</a>
            <a href="/students/profile.html" class="account-link" data-i18n="View Profile">View Profile</a>
            <a href="#" class="account-link" data-i18n="Logout">Logout</a>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section class="card">
        <h2 class="card-title" data-i18n="Settings">Settings</h2>
        <div class="card-content">
          <div class="settings-list">
            <div class="settings-row" id="langRow">
              <span class="settings-label" data-i18n="Language">Language</span>
              <span id="langKoLabel" class="lang-label" data-i18n="Kor">Kor</span>
              <span id="langToggle" class="settings-switch" role="switch" aria-checked="false" tabindex="0" title="Toggle Language"></span>
              <span id="langEnLabel" class="lang-label" data-i18n="Eng">Eng</span>
            </div>
            <div class="settings-row" id="darkModeRow">
              <span class="settings-label" data-i18n="Dark Mode">Dark Mode</span>
              <span class="settings-muted" id="darkModeStatus" data-i18n="Off">Off</span>
              <span id="darkModeToggle" class="settings-switch" role="switch" aria-checked="false" tabindex="0" title="Toggle Dark Mode"></span>
            </div>
            <div class="settings-row">
              <span class="settings-label" data-i18n="Music">Music</span>
              <span class="settings-muted" data-i18n="Off">Off</span>
              <span class="settings-switch"></span>
            </div>
          </div>
        </div>
      </section>
      <!-- Your Work -->
      <section class="card" id="homeworkCard">
        <h2 class="card-title" data-i18n="Homework">Homework</h2>
        <div class="card-content homework-scroll" style="display:flex;align-items:center;justify-content:center;min-height:280px;max-height:560px;">
          <!-- Homework cards will be rendered here -->
        </div>
      </section>
    </div>
  </div>
  <script>
    document.getElementById('logoutBig')?.addEventListener('click', async () => {
  try { sessionStorage.removeItem('missionModalShown'); sessionStorage.removeItem('wa_hw_tap_hint_shown'); } catch {}
  try { WillenaAPI.clearLocalTokens?.(); } catch {} // Clear localStorage tokens
  await WillenaAPI.fetch('/api/supabase_auth?action=logout', { method:'POST' });
  location.href = '/students/login.html';
    });
  </script>
  <script>
    // Unified language switch with animated knob; only switch is interactive
    (function(){
      function setActiveStyles(){
        if(!window.StudentLang) return;
        const cur = StudentLang.getLang();
        const ko = document.getElementById('langKoLabel');
        const en = document.getElementById('langEnLabel');
        const sw = document.getElementById('langToggle');
        if(ko) ko.classList.toggle('active', cur==='ko');
        if(en) en.classList.toggle('active', cur==='en');
        if(sw) sw.setAttribute('aria-checked', cur==='en');
      }
      function toggle(){ if(!window.StudentLang) return; StudentLang.setLang(StudentLang.getLang()==='en'?'ko':'en'); setActiveStyles(); }
      document.addEventListener('DOMContentLoaded', () => {
        const sw = document.getElementById('langToggle');
        if(sw){
          sw.addEventListener('click', toggle);
          sw.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
        }
        setActiveStyles();
      });
      window.addEventListener('studentlang:changed', setActiveStyles);
    })();
  </script>

  <script>
    // Wire dark mode toggle to shared StudentTheme
    (function(){
      function init(){
        const sw = document.getElementById('darkModeToggle');
        if(!sw) return;
        const activate = () => { if(window.StudentTheme) StudentTheme.toggle(); };
        sw.addEventListener('click', activate);
        sw.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); activate(); }});
      }
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
      // StudentTheme.apply already performs the DOM updates; avoid calling apply again here to prevent recursion
      window.addEventListener('studenttheme:changed', () => { /* no-op: theme already applied by StudentTheme */ });
    })();
  </script>

  <!-- Change Password Modal -->
  <div id="pwModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;padding:20px;">
    <div class="modal" style="max-width:400px;width:100%;border-radius:14px;padding:24px;position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.15);font-family:'Poppins',sans-serif;">
      <button id="pwClose" aria-label="Close" style="position:absolute;top:8px;right:10px;background:none;border:none;font-size:20px;cursor:pointer;">×</button>
      <h2 style="margin:0 0 12px;font-size:1.4rem;font-weight:800;color:#19777e;" data-i18n="Change Password">Change Password</h2>
      <form id="pwForm">
        <label style="display:block;font-weight:600;margin:10px 0 6px;color:#19777e;" for="pwCurrent" data-i18n="Current Password">Current Password</label>
        <div style="position:relative;">
          <input id="pwCurrent" type="password" style="width:100%;box-sizing:border-box;padding:6px 42px 6px 10px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;" autocomplete="current-password" />
          <button type="button" data-target="pwCurrent" class="pw-toggle pw-eye" aria-pressed="false" aria-label="Show password" title="Show password" style="position:absolute;top:50%;right:8px;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#19777e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <label style="display:block;font-weight:600;margin:14px 0 6px;color:#19777e;" for="pwNew" data-i18n="New Password">New Password</label>
        <div style="position:relative;">
          <input id="pwNew" type="password" style="width:100%;box-sizing:border-box;padding:6px 42px 6px 10px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;" autocomplete="new-password" />
          <button type="button" data-target="pwNew" class="pw-toggle pw-eye" aria-pressed="false" aria-label="Show password" title="Show password" style="position:absolute;top:50%;right:8px;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#19777e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <label style="display:block;font-weight:600;margin:14px 0 6px;color:#19777e;" for="pwNew2" data-i18n="Confirm Password">Confirm Password</label>
        <div style="position:relative;">
          <input id="pwNew2" type="password" style="width:100%;box-sizing:border-box;padding:6px 42px 6px 10px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;" autocomplete="new-password" />
          <button type="button" data-target="pwNew2" class="pw-toggle pw-eye" aria-pressed="false" aria-label="Show password" title="Show password" style="position:absolute;top:50%;right:8px;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#19777e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <div id="pwMsg" style="margin-top:12px;font-size:0.9rem;font-weight:600;color:#b00020;display:none;"></div>
        <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end;">
          <button type="button" id="pwCancel" style="background:#e6eaef;color:#19777e;font-weight:600;padding:10px 18px;border-radius:10px;border:none;cursor:pointer;" data-i18n="Cancel">Cancel</button>
          <button type="submit" id="pwSubmit" style="background:linear-gradient(135deg,#67e2e6,#93cbcf);color:#fff;font-weight:700;padding:10px 20px;border-radius:10px;border:none;cursor:pointer;" data-i18n="Save">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Email Modal -->
  <div id="emailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;padding:20px;">
    <div class="modal" style="max-width:400px;width:100%;border-radius:14px;padding:24px;position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.15);font-family:'Poppins',sans-serif;">
      <button id="emailClose" aria-label="Close" style="position:absolute;top:8px;right:10px;background:none;border:none;font-size:20px;cursor:pointer;">×</button>
      <h2 style="margin:0 0 12px;font-size:1.4rem;font-weight:800;color:#19777e;" data-i18n="Change Email">Change Email</h2>
      <form id="emailForm">
        <label style="display:block;font-weight:600;margin:10px 0 6px;color:#19777e;" for="emailCurrentPw" data-i18n="Current Password">Current Password</label>
        <input id="emailCurrentPw" type="password" style="width:100%;box-sizing:border-box;padding:6px 10px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;" autocomplete="current-password" />
        <label style="display:block;font-weight:600;margin:14px 0 6px;color:#19777e;" for="newEmail" data-i18n="New Email">New Email</label>
        <input id="newEmail" type="email" style="width:100%;box-sizing:border-box;padding:6px 10px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;" autocomplete="email" />
        <label style="display:block;font-weight:600;margin:14px 0 6px;color:#19777e;" for="newEmail2" data-i18n="Confirm Email">Confirm Email</label>
        <input id="newEmail2" type="email" style="width:100%;box-sizing:border-box;padding:6px 10px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;" autocomplete="email" />
        <div id="emailMsg" style="margin-top:12px;font-size:0.9rem;font-weight:600;color:#b00020;display:none;"></div>
        <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end;">
          <button type="button" id="emailCancel" style="background:#e6eaef;color:#19777e;font-weight:600;padding:10px 18px;border-radius:10px;border:none;cursor:pointer;" data-i18n="Cancel">Cancel</button>
          <button type="submit" id="emailSubmit" style="background:linear-gradient(135deg,#67e2e6,#93cbcf);color:#fff;font-weight:700;padding:10px 20px;border-radius:10px;border:none;cursor:pointer;" data-i18n="Save">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const link = document.getElementById('changePasswordLink');
      const modal = document.getElementById('pwModal');
      const closeBtn = document.getElementById('pwClose');
      const cancelBtn = document.getElementById('pwCancel');
      const form = document.getElementById('pwForm');
      const msg = document.getElementById('pwMsg');
      const cur = document.getElementById('pwCurrent');
      const pw1 = document.getElementById('pwNew');
      const pw2 = document.getElementById('pwNew2');
      function t(k){ return (window.StudentLang && StudentLang.translate(k)) || k; }
      function showModal(){ if(modal){ modal.style.display='flex'; msg.style.display='none'; form.reset(); cur.focus(); if(window.StudentLang) StudentLang.applyTranslations(); } }
      function hideModal(){ if(modal){ modal.style.display='none'; } }
      function showError(txt){ if(!msg) return; msg.style.color='#b00020'; msg.textContent=txt; msg.style.display=txt?'block':'none'; }
      function showSuccess(txt){ if(!msg) return; msg.style.color='#19777e'; msg.textContent=txt; msg.style.display=txt?'block':'none'; }
      if(link) link.addEventListener('click', e=>{ e.preventDefault(); showModal(); });
      [closeBtn,cancelBtn].forEach(b=> b && b.addEventListener('click', e=>{ e.preventDefault(); hideModal(); }));
      modal?.addEventListener('click', e=>{ if(e.target===modal) hideModal(); });
      form?.addEventListener('submit', async e=>{
        e.preventDefault(); showError('');
        const c = cur.value.trim(); const n1 = pw1.value.trim(); const n2 = pw2.value.trim();
        if(!c || !n1 || !n2) return showError(t('Please enter both username and password.')); // reuse generic msg key
        if(n1.length < 6) return showError(t('Password must be at least 6 characters.'));
        if(n1 !== n2) return showError(t('Passwords do not match'));
        try {
          const r = await WillenaAPI.fetch('/api/supabase_auth?action=change_password', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ current_password:c, new_password:n1 }) });
          const j = await r.json().catch(()=>({}));
          if(!j.success){
            if(j.error_code==='bad_current') return showError(t('Incorrect current password'));
            return showError(t(j.error||'Login failed'));
          }
          showSuccess(t('Password updated'));
          setTimeout(hideModal, 1400);
        } catch { showError(t('Login failed')); }
      });
      // Password visibility toggles
      function togglePw(btn){
        const id = btn.getAttribute('data-target');
        const input = document.getElementById(id);
        if(!input) return;
        const showing = input.type === 'text';
        input.type = showing ? 'password' : 'text';
        btn.setAttribute('aria-pressed', String(!showing));
        const stroke = window.getComputedStyle(btn.querySelector('svg')).stroke || '#19777e';
        // Replace SVG icon
        btn.innerHTML = showing
          ? `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="${stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.77 21.77 0 0 1 5.06-6.94m4.21-2.29A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a21.77 21.77 0 0 1-2.16 3.19M9.9 9.9a3 3 0 0 0 4.2 4.2M1 1l22 22"/></svg>`
          : `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="${stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        btn.setAttribute('aria-label', showing ? t('Show') : t('Hide'));
        btn.setAttribute('title', showing ? t('Show') : t('Hide'));
      }
      document.querySelectorAll('#pwModal .pw-toggle').forEach(btn=>{
        btn.addEventListener('click', ()=> togglePw(btn));
      });
      window.addEventListener('studentlang:changed', ()=>{ if(modal?.style.display==='flex'){ if(window.StudentLang) StudentLang.applyTranslations(); } });
    })();
  </script>

  <script>
    // Change Email Modal logic
    (function(){
      const link = document.getElementById('changeEmailLink');
      const modal = document.getElementById('emailModal');
      const closeBtn = document.getElementById('emailClose');
      const cancelBtn = document.getElementById('emailCancel');
      const form = document.getElementById('emailForm');
      const msg = document.getElementById('emailMsg');
      const curPw = document.getElementById('emailCurrentPw');
      const em1 = document.getElementById('newEmail');
      const em2 = document.getElementById('newEmail2');
      function t(k){ return (window.StudentLang && StudentLang.translate(k)) || k; }
      function showError(txt){ if(!msg) return; msg.style.color='#b00020'; msg.textContent=txt; msg.style.display=txt?'block':'none'; }
      function showSuccess(txt){ if(!msg) return; msg.style.color='#19777e'; msg.textContent=txt; msg.style.display=txt?'block':'none'; }
      function showModal(){ if(!modal) return; modal.style.display='flex'; msg.style.display='none'; form.reset(); curPw.focus(); if(window.StudentLang) StudentLang.applyTranslations(); }
      function hideModal(){ if(modal) modal.style.display='none'; }
      if(link) link.addEventListener('click', e=>{ e.preventDefault(); showModal(); });
      ;[closeBtn,cancelBtn].forEach(b=> b && b.addEventListener('click', e=>{ e.preventDefault(); hideModal(); }));
      modal?.addEventListener('click', e=>{ if(e.target===modal) hideModal(); });
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
      form?.addEventListener('submit', async e=>{
        e.preventDefault(); showError('');
        const cp = curPw.value.trim(); const e1 = em1.value.trim(); const e2 = em2.value.trim();
        if(!cp || !e1 || !e2) return showError(t('Please enter both username and password.'));
        if(e1.toLowerCase() !== e2.toLowerCase()) return showError(t('Emails do not match'));
        if(!emailRegex.test(e1)) return showError(t('Invalid email address'));
        try {
          const r = await WillenaAPI.fetch('/api/supabase_auth?action=change_email', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ current_password:cp, new_email:e1 }) });
          const j = await r.json().catch(()=>({}));
          if(!j.success){
            if(j.error_code==='bad_current') return showError(t('Incorrect current password'));
            if(j.error_code==='email_in_use') return showError(t('Email already in use'));
            if(j.error_code==='invalid_email') return showError(t('Invalid email address'));
            return showError(t(j.error||'Login failed'));
          }
          showSuccess(t('Email updated'));
          setTimeout(hideModal, 1400);
        } catch { showError(t('Login failed')); }
      });
      window.addEventListener('studentlang:changed', ()=>{ if(modal?.style.display==='flex'){ if(window.StudentLang) StudentLang.applyTranslations(); } });
    })();
  </script>

  <script>
    (async () => {
      try {
        const el = document.getElementById('dashboardClassName');
        if (!el) return;
        // First try get_profile_name (returns class)
        let cls = null;
        try {
          const r1 = await WillenaAPI.fetch('/api/supabase_auth?action=get_profile_name');
          const j1 = await r1.json().catch(() => ({}));
          if (j1 && j1.class) cls = j1.class;
        } catch {}
        // Fallback to get_profile
        if (!cls) {
          try {
            const r2 = await WillenaAPI.fetch('/api/supabase_auth?action=get_profile');
            const j2 = await r2.json().catch(() => ({}));
            if (j2 && j2.class) cls = j2.class;
          } catch {}
        }
        if (cls && typeof cls === 'string') {
          el.textContent = `${cls} Class`;
        }
      } catch {}
    })();
  </script>

  <script>
    // Load homework into "Your Work" card
    (async () => {
      const container = document.querySelector('.card-content.homework-scroll');
      if (!container) return;

      const t = (k) => (window.StudentLang && StudentLang.translate(k)) || k;

      function render(assignments) {
        container.innerHTML = '';
        const t = (k) => (window.StudentLang && StudentLang.translate(k)) || k;
        if (!assignments || !assignments.length) {
          const div = document.createElement('div');
          div.style.fontSize = '1rem';
          div.style.color = '#888';
          div.textContent = t('No homework assigned.');
          container.appendChild(div);
          return;
        }

        // Host layout with centered heading and two stacked sections (Incomplete then Complete)
        const host = document.createElement('div');
        host.style.width = '100%';
        host.style.display = 'flex';
        host.style.flexDirection = 'column';
        host.style.gap = '12px';

        const heading = document.createElement('div');
        heading.style.textAlign = 'center';
        heading.style.fontSize = '1rem';
        heading.style.fontWeight = '700';
        heading.style.color = '#bfeef6';
        heading.style.textTransform = 'lowercase';
        host.appendChild(heading);

        // Sections
        const sectionWrap = document.createElement('div');
        sectionWrap.style.display = 'flex';
        sectionWrap.style.flexDirection = 'column';
        sectionWrap.style.gap = '14px';

        const incompleteSection = document.createElement('section');
        const incTitle = document.createElement('div');
        incTitle.textContent = '해야 할 숙제';
        incTitle.style.fontSize = '0.95rem';
        incTitle.style.fontWeight = '700';
        incTitle.style.color = '#67e2e6';
        incompleteSection.appendChild(incTitle);
        const incList = document.createElement('div');
        incList.style.display = 'flex';
        incList.style.flexDirection = 'column';
        incList.style.gap = '8px';
        incList.style.maxHeight = '240px';
        incList.style.overflowY = 'auto';
        incompleteSection.appendChild(incList);

        const completeSection = document.createElement('section');
        const compTitle = document.createElement('div');
        compTitle.textContent = '완료된 숙제';
        compTitle.style.fontSize = '0.95rem';
        compTitle.style.fontWeight = '700';
        compTitle.style.color = '#67e2e6';
        completeSection.appendChild(compTitle);
        const compList = document.createElement('div');
        compList.style.display = 'flex';
        compList.style.flexDirection = 'column';
        compList.style.gap = '8px';
        compList.style.maxHeight = '240px';
        compList.style.overflowY = 'auto';
        completeSection.appendChild(compList);

        sectionWrap.appendChild(incompleteSection);
        sectionWrap.appendChild(completeSection);
        host.appendChild(sectionWrap);

        // Create cards and append to sections based on progress
        assignments.forEach(a => {
          const li = document.createElement('div');
          li.style.padding = '12px 14px';
          li.style.borderRadius = '10px';
          li.style.background = '#26313a'; // dark grey-blue
          li.style.color = '#fff'; // white text
          li.style.display = 'flex';
          li.style.flexDirection = 'column';
          li.style.gap = '6px';
          li.style.cursor = 'pointer';
          li.style.boxShadow = '0 2px 8px rgba(34,211,238,0.08), 0 1px 3px rgba(0,0,0,.04)';
          li.style.border = '2px solid #22d3ee';
          li.style.transition = 'box-shadow 0.18s, transform 0.18s, border-color 0.18s';
          li.addEventListener('mouseenter',()=>{li.style.boxShadow='0 4px 16px rgba(34,211,238,0.18), 0 2px 8px rgba(0,0,0,.08)';li.style.borderColor='#06b6d4';});
          li.addEventListener('mouseleave',()=>{li.style.boxShadow='0 2px 8px rgba(34,211,238,0.08), 0 1px 3px rgba(0,0,0,.04)';li.style.borderColor='#22d3ee';});

          const title = document.createElement('div');
          title.style.fontWeight = '600';
          title.style.fontSize = '1rem';
          title.style.color = '#fff';
          title.textContent = a.title || a.list_title || t('Homework');

          // Countdown calculation
          let countdown = '';
          if (a.due_at) {
            const dueDate = new Date(a.due_at);
            const now = new Date();
            let diff = dueDate - now;
            if (diff > 0) {
              const days = Math.floor(diff / (1000 * 60 * 60 * 24));
              diff -= days * (1000 * 60 * 60 * 24);
              const hours = Math.floor(diff / (1000 * 60 * 60));
              diff -= hours * (1000 * 60 * 60);
              const minutes = Math.floor(diff / (1000 * 60));
              countdown = `${days > 0 ? days + 'd ' : ''}${hours}h ${minutes}m left`;
            } else {
              countdown = 'Past due';
            }
          }

          const countdownDiv = document.createElement('div');
          countdownDiv.style.fontSize = '0.85rem';
          countdownDiv.style.color = '#bafcff';
          countdownDiv.textContent = a.due_at ? `${countdown}` : t('No due date');

          // Teacher name (if available)
          const teacher = document.createElement('div');
          teacher.style.fontSize = '0.8rem';
          teacher.style.color = '#e0e0e0';
          teacher.textContent = a.teacher_name ? `${t('Teacher')}: ${a.teacher_name}` : '';

          // Progress bar
          const progress = typeof a.completion_pct === 'number' ? a.completion_pct : (a.completion || 0);
          const progressBar = document.createElement('div');
          progressBar.style.height = '8px';
          progressBar.style.width = '100%';
          progressBar.style.background = '#444c53';
          progressBar.style.borderRadius = '6px';
          progressBar.style.margin = '6px 0 2px 0';
          progressBar.style.overflow = 'hidden';
          const progressFill = document.createElement('div');
          progressFill.style.height = '100%';
          progressFill.style.width = Math.max(6, Math.min(100, Math.round(progress))) + '%';
          progressFill.style.background = 'linear-gradient(90deg,#22d3ee,#19777e)';
          progressFill.style.borderRadius = '6px';
          progressBar.appendChild(progressFill);
          const progressLabel = document.createElement('div');
          progressLabel.style.fontSize = '0.75rem';
          progressLabel.style.color = '#bafcff';
          progressLabel.style.marginBottom = '2px';
          progressLabel.textContent = t('Progress') + ': ' + Math.round(progress) + '%';

          // Card click launches homework
          li.addEventListener('click', () => {
            if (a.list_key) {
              window.location.href = `/Games/english_arcade/index.html?hw=${encodeURIComponent(a.id)}&list=${encodeURIComponent(a.list_key)}&autostart=1`;
            } else if (a.list_title) {
              window.location.href = `/Games/english_arcade/index.html?list=${encodeURIComponent(a.list_title)}&autostart=1`;
            } else {
              window.location.href = '/Games/english_arcade/index.html';
            }
          });

          li.appendChild(title);
          if (progress >= 100) {
            const doneMsg = document.createElement('div');
            doneMsg.style.fontWeight = '700';
            doneMsg.style.fontSize = '1.05rem';
            doneMsg.style.color = '#ffd86f';
            doneMsg.style.margin = '8px 0 4px 0';
            doneMsg.textContent = 'Nice! Homework Done!';
            li.appendChild(doneMsg);
            // Dynamic stars earned display
            const starsWrap = document.createElement('div');
            starsWrap.style.display = 'flex';
            starsWrap.style.alignItems = 'center';
            starsWrap.style.gap = '6px';
            starsWrap.style.marginBottom = '8px';
            const starIcon = document.createElement('span');
            starIcon.innerHTML = '&#9733;';
            starIcon.style.color = '#ffd86f';
            starIcon.style.fontSize = '1.4rem';
            starIcon.style.textShadow = '0 0 8px rgba(255,216,111,0.6)';
            starsWrap.appendChild(starIcon);
            const starsLabel = document.createElement('span');
            const totalStars = (typeof a.stars === 'number') ? a.stars : (a.stars || 0);
            starsLabel.textContent = totalStars + ' Stars Earned';
            starsLabel.style.fontSize = '0.85rem';
            starsLabel.style.fontWeight = '600';
            starsLabel.style.color = '#ffd86f';
            starsWrap.appendChild(starsLabel);
            li.appendChild(starsWrap);
          } else {
            li.appendChild(countdownDiv);
            li.appendChild(progressLabel);
            li.appendChild(progressBar);
          }
          if (teacher.textContent) li.appendChild(teacher);

          // Append to proper section
          if (progress >= 100) compList.appendChild(li); else incList.appendChild(li);
        });

        // Empty-section messages
        if (!incList.children.length) {
          const m = document.createElement('div'); m.style.color='#9aa'; m.style.padding='8px 0'; m.textContent=t('No incomplete homework.'); incList.appendChild(m);
        }
        if (!compList.children.length) {
          const m2 = document.createElement('div'); m2.style.color='#9aa'; m2.style.padding='8px 0'; m2.textContent=t('No completed homework yet.'); compList.appendChild(m2);
        }

        container.appendChild(host);
      }

      // Show loading text
      container.innerHTML = `<div style="font-size:1rem;color:#888;">${t('Loading...')}</div>`;

      try {
        // Determine current student user_id first so we can match progress rows
        let currentUserId = null;
        try {
          const whoRes = await WillenaAPI.fetch(`/api/supabase_auth?action=whoami&_=${Date.now()}`);
          const whoJson = await whoRes.json().catch(()=>({}));
          if (whoRes.ok && whoJson.success && whoJson.user_id) currentUserId = whoJson.user_id;
        } catch {}
        // Fallback to get_profile_name for user id if needed (returns nothing? then skip)
        if (!currentUserId) {
          try {
            const profRes = await WillenaAPI.fetch('/api/supabase_auth?action=get_profile');
            const profJson = await profRes.json().catch(()=>({}));
            if (profRes.ok && profJson.success && profJson.id) currentUserId = profJson.id;
          } catch {}
        }
        const resp = await WillenaAPI.fetch(`/api/homework_api?action=list_assignments&mode=student&_=${Date.now()}`);
        const text = await resp.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (e) {
          console.error('student homework non-JSON', text);
        }
        if (!resp.ok || !data.success) {
          container.innerHTML = `<div style="font-size:1rem;color:#b00020;">${(data && data.error) || t('Error loading homework.')}</div>`;
          return;
        }

        // Fetch progress for each assignment
        const assignmentsWithProgress = await Promise.all(
          (data.assignments || []).map(async (assignment) => {
            try {
              const progressResp = await WillenaAPI.fetch(
                `/api/homework_api?action=assignment_progress&assignment_id=${encodeURIComponent(assignment.id)}&_=${Date.now()}`
              );
              const progressData = await progressResp.json();
              
              if (progressResp.ok && progressData.success && Array.isArray(progressData.progress)) {
                // Find current student's progress row explicitly
                let studentProgress = null;
                if (currentUserId) {
                  studentProgress = progressData.progress.find(p => p.user_id === currentUserId) || null;
                }
                // If user id missing, but only one row and names match profile name, allow fallback
                if (!studentProgress && progressData.progress.length === 1) {
                  studentProgress = progressData.progress[0];
                }
                if (studentProgress) {
                  // Derive completion percent robustly
                  let completionPct = 0;
                  if (typeof studentProgress.completion === 'number') completionPct = studentProgress.completion;
                  else if (typeof studentProgress.completion_pct === 'number') completionPct = studentProgress.completion_pct;
                  else if (typeof studentProgress.modes_attempted === 'number' && typeof studentProgress.modes_total === 'number' && studentProgress.modes_total > 0) {
                    completionPct = Math.round((studentProgress.modes_attempted / studentProgress.modes_total) * 100);
                  }
                  // Clamp
                  completionPct = Math.max(0, Math.min(100, completionPct));
                  return {
                    ...assignment,
                    completion_pct: completionPct,
                    stars: studentProgress.stars || 0,
                    accuracy: studentProgress.accuracy_best || 0,
                    teacher_name: assignment.teacher_name || data.teacher_name || null
                  };
                }
              }
            } catch (err) {
              console.warn('Failed to fetch progress for assignment', assignment.id, err);
            }
            return assignment;
          })
        );

        render(assignmentsWithProgress);
        
        // Show homework container only if there are assignments
        const hwContainer = document.getElementById('homeworkCard');
        if (hwContainer) {
          hwContainer.style.display = (assignmentsWithProgress.length > 0) ? 'block' : 'none';
        }
      } catch (err) {
        console.error('load dashboard homework error', err);
        container.innerHTML = `<div style="font-size:1rem;color:#b00020;">${t('Error loading homework.')}</div>`;
      }
    })();
  </script>

  <script>
    // Leaderboards rendering
    (async function() {
      const t = (k) => (window.StudentLang && StudentLang.translate(k)) || k;
      
      // Normalize class names (e.g., "NY" -> "New York", "CA" -> "California")
      function normalizeClassName(name) {
        if (!name || typeof name !== 'string') return name;
        const stateMap = {
          'NY': 'New York',
          'CA': 'California',
          'TX': 'Texas',
          'FL': 'Florida',
          'PA': 'Pennsylvania',
          'IL': 'Illinois',
          'OH': 'Ohio',
          'GA': 'Georgia',
          'NC': 'North Carolina',
          'MI': 'Michigan',
          'NJ': 'New Jersey',
          'VA': 'Virginia',
          'WA': 'Washington',
          'AZ': 'Arizona',
          'MA': 'Massachusetts',
          'TN': 'Tennessee',
          'IN': 'Indiana',
          'MD': 'Maryland',
          'MO': 'Missouri',
          'WI': 'Wisconsin',
          'CO': 'Colorado',
          'MN': 'Minnesota',
          'SC': 'South Carolina',
          'AL': 'Alabama',
          'LA': 'Louisiana',
          'KY': 'Kentucky',
          'OR': 'Oregon',
          'OK': 'Oklahoma',
          'CT': 'Connecticut',
          'UT': 'Utah',
          'NV': 'Nevada',
          'AR': 'Arkansas',
          'MS': 'Mississippi',
          'KS': 'Kansas',
          'NM': 'New Mexico',
          'NE': 'Nebraska',
          'ID': 'Idaho',
          'HI': 'Hawaii',
          'NH': 'New Hampshire',
          'ME': 'Maine',
          'RI': 'Rhode Island',
          'MT': 'Montana',
          'DE': 'Delaware',
          'SD': 'South Dakota',
          'ND': 'North Dakota',
          'AK': 'Alaska',
          'VT': 'Vermont',
          'WY': 'Wyoming',
          'WV': 'West Virginia',
          'DC': 'Washington D.C.'
        };
        return stateMap[name.trim().toUpperCase()] || name;
      }
      
      // Rank badges with SVG medals for top 3
      function getRankBadge(rank) {
        const medalSvgs = { 
          1: '/Games/english_arcade/assets/Images/icons/gold.svg', 
          2: '/Games/english_arcade/assets/Images/icons/silver.svg', 
          3: '/Games/english_arcade/assets/Images/icons/bronze.svg' 
        };
        if (medalSvgs[rank]) {
          return `<img src="${medalSvgs[rank]}" alt="Rank ${rank}" class="rank-medal">`;
        }
        return `${rank}.`;
      }

      // Render class leaderboard
      // Render class leaderboard with metric-aware presentation
      function renderStarsLeaderboard(containerId, cardId, data, metric) {
        const container = document.getElementById(containerId);
        const card = document.getElementById(cardId);
        const classNameEl = document.getElementById('starsClassNameDisplay');
        if (!container || !card) return;

        if (!data || !data.success || !Array.isArray(data.leaderboard) || data.leaderboard.length === 0) {
          container.innerHTML = `<p style="text-align:center;color:#666;">${t('No data available')}</p>`;
          if (classNameEl && data?.class) classNameEl.textContent = normalizeClassName(data.class);
          return;
        }

        if (classNameEl && data.class) classNameEl.textContent = normalizeClassName(data.class);

        const normalized = data.leaderboard.map(entry => {
          const stars = Number(entry.stars) || 0;
          const points = Number(entry.points) || 0;
          const superScore = Math.round((stars * points) / 1000);
          return {
            ...entry,
            name: entry.name || 'Student',
            stars,
            points,
            superScore
          };
        });

        const compare = (a, b) => {
          if (metric === 'points') return (b.points - a.points) || (b.stars - a.stars) || a.name.localeCompare(b.name);
          if (metric === 'super') return (b.superScore - a.superScore) || (b.stars - a.stars) || a.name.localeCompare(b.name);
          // default stars
          return (b.stars - a.stars) || (b.points - a.points) || a.name.localeCompare(b.name);
        };

        const sorted = normalized.slice().sort(compare);

        const metricDisplay = (entry) => {
          if (metric === 'points') {
            return { primary: `${entry.points.toLocaleString()} ${t('pts')}`, primaryClass: 'metric-points' };
          }
          if (metric === 'super') {
            return { primary: `${entry.superScore.toLocaleString()} ⚡`, primaryClass: 'metric-super' };
          }
          return { primary: `${entry.stars.toLocaleString()} ⭐`, primaryClass: 'metric-stars' };
        };

        let html = '<ul class="leaderboard-list">';
        sorted.forEach((entry, index) => {
          const rank = index + 1;
          const rankBadgeHtml = getRankBadge(rank);
          const selfClass = entry.self ? ' self' : '';
          const selfBadge = entry.self ? `<span class="you-badge">${t('You')}</span>` : '';
          const { primary, primaryClass } = metricDisplay(entry);
          html += `
            <li class="leaderboard-item${selfClass}" data-rank="${rank}">
              <span class="rank-badge">${rankBadgeHtml}</span>
              <div class="player-info">
                <span class="player-name">${entry.name}</span>
              </div>
              ${selfBadge}
              <div class="player-metric">
                <div class="metric-primary ${primaryClass}">${primary}</div>
              </div>
            </li>
          `;
        });
        html += '</ul>';
        container.innerHTML = html;
      }

      // Render global leaderboard with metric-aware presentation
      function renderGlobalLeaderboard(containerId, cardId, data, metric) {
        const container = document.getElementById(containerId);
        const card = document.getElementById(cardId);
        if (!container || !card) return;

        if (!data || !data.success || !Array.isArray(data.leaderboard) || data.leaderboard.length === 0) {
          container.innerHTML = `<p style="text-align:center;color:#666;">${t('No data available')}</p>`;
          return;
        }

        const normalized = data.leaderboard.map(entry => {
          const stars = Number(entry.stars) || 0;
          const points = Number(entry.points) || 0;
          const superScore = Math.round((stars * points) / 1000);
          return {
            ...entry,
            name: entry.name || 'Student',
            class: entry.class ? normalizeClassName(entry.class) : null,
            stars,
            points,
            superScore
          };
        });

        const compare = (a, b) => {
          if (metric === 'points') return (b.points - a.points) || (b.stars - a.stars) || a.name.localeCompare(b.name);
          if (metric === 'super') return (b.superScore - a.superScore) || (b.stars - a.stars) || a.name.localeCompare(b.name);
          return (b.stars - a.stars) || (b.points - a.points) || a.name.localeCompare(b.name);
        };

        const metricDisplay = (entry) => {
          if (metric === 'points') {
            return { primary: `${entry.points.toLocaleString()} ${t('pts')}`, primaryClass: 'metric-points' };
          }
          if (metric === 'super') {
            return { primary: `${entry.superScore.toLocaleString()} ⚡`, primaryClass: 'metric-super' };
          }
          return { primary: `${entry.stars.toLocaleString()} ⭐`, primaryClass: 'metric-stars' };
        };

        const sorted = normalized.slice().sort(compare);

        let html = '<ul class="leaderboard-list">';
        sorted.forEach((entry, index) => {
          const rank = index + 1;
          const rankBadgeHtml = getRankBadge(rank);
          const selfClass = entry.self ? ' self' : '';
          const selfBadge = entry.self ? `<span class="you-badge">${t('You')}</span>` : '';
          const { primary, primaryClass } = metricDisplay(entry);
          const classDisplay = entry.class ? `<span class="player-class">${entry.class}</span>` : '';
          html += `
            <li class="leaderboard-item${selfClass}" data-rank="${rank}">
              <span class="rank-badge">${rankBadgeHtml}</span>
              <div class="player-info">
                <span class="player-name">${entry.name}</span>
                ${classDisplay}
              </div>
              ${selfBadge}
              <div class="player-metric">
                <div class="metric-primary ${primaryClass}">${primary}</div>
              </div>
            </li>
          `;
        });
        html += '</ul>';
        container.innerHTML = html;
      }

      // Fetch and render stars leaderboard
      let starsLbTimeframe = 'month'; // 'all' | 'month' - default to month
      let starsLbMetric = 'super'; // default to 'super' (Super Score)
      // In-memory cache scoped by timeframe _and_ current userId to avoid cross-account pollution
      const starsLbCache = new Map(); // key: <timeframe>_<userId> -> data
      const LB_LOCAL_CACHE_TTL = 2 * 60 * 1000; // 2 minutes for stale-while-revalidate

      // Get current user ID for cache key scoping (prevents cross-account cache pollution)
      function getCurrentUserId() {
        try {
          // Try to get from WillenaAPI or window state
          if (window.WillenaAPI?.userId) return window.WillenaAPI.userId;
          // Fallback: extract from any stored auth state
          const authState = sessionStorage.getItem('sb_user_id') || localStorage.getItem('sb_user_id');
          return authState || 'anon';
        } catch { return 'anon'; }
      }

      // Local storage cache helpers for instant UI - scoped by user ID
      function getLbFromLocal(key) {
        try {
          const userId = getCurrentUserId();
          const fullKey = `${key}_${userId}`;
          const raw = localStorage.getItem(fullKey);
          if (!raw) return null;
          const { data, ts } = JSON.parse(raw);
          return { data, ts, stale: Date.now() - ts > LB_LOCAL_CACHE_TTL };
        } catch { return null; }
      }
      function setLbToLocal(key, data) {
        try {
          const userId = getCurrentUserId();
          const fullKey = `${key}_${userId}`;
          localStorage.setItem(fullKey, JSON.stringify({ data, ts: Date.now() }));
        } catch {}
      }
      function clearLbLocalCache(key) {
        try {
          const userId = getCurrentUserId();
          const fullKey = `${key}_${userId}`;
          localStorage.removeItem(fullKey);
        } catch {}
      }

      async function loadStarsLeaderboard(timeframe = starsLbTimeframe, forceRefresh = false) {
        const spinner = document.getElementById('starsSmallSpinner');
        starsLbTimeframe = timeframe;

        // For class leaderboard, don't use localStorage cache - it's user-specific
        // Use in-memory cache scoped by userId for tab switching
        const userId = getCurrentUserId();
        const memKey = `${timeframe}_${userId}`;
        const memCached = starsLbCache.get(memKey);
        if (memCached && !forceRefresh) {
          renderStarsLeaderboard('starsLeaderboardContent', 'starsLeaderboardCard', memCached, starsLbMetric);
          return;
        }

        try {
          spinner?.classList.remove('hidden');
          // Use bypass_cache=1 when force refreshing to get fresh data from server
          const bypassParam = forceRefresh ? '&bypass_cache=1' : '';
          // Include a user-scoped param so CDN/cache layers don't serve another student's class leaderboard
          const url = `/api/progress_summary?section=leaderboard_stars_class&timeframe=${encodeURIComponent(timeframe)}${bypassParam}&u=${encodeURIComponent(userId)}`;
          const r = await WillenaAPI.fetch(url);
          const data = await r.json();
          starsLbCache.set(memKey, data);
          renderStarsLeaderboard('starsLeaderboardContent', 'starsLeaderboardCard', data, starsLbMetric);
        } catch (err) {
          console.error('Stars leaderboard error:', err);
          const container = document.getElementById('starsLeaderboardContent');
          if (container) container.innerHTML = `<p style="color:#b00020;">${t('Failed to load')}</p>`;
        } finally {
          spinner?.classList.add('hidden');
        }
      }

      function updateStarsLbFilterUI() {
        const allBtn = document.getElementById('slFilterAll');
        const monBtn = document.getElementById('slFilterMonth');
        if (!allBtn || !monBtn) return;
        if (starsLbTimeframe === 'month') {
          monBtn.classList.add('active');
          monBtn.setAttribute('aria-pressed','true');
          allBtn.classList.remove('active');
          allBtn.setAttribute('aria-pressed','false');
        } else {
          allBtn.classList.add('active');
          allBtn.setAttribute('aria-pressed','true');
          monBtn.classList.remove('active');
          monBtn.setAttribute('aria-pressed','false');
        }
      }

      function updateStarsMetricUI() {
        document.querySelectorAll('#starsLeaderboardTabs .lb-tab').forEach(btn => {
          const metric = btn.getAttribute('data-metric');
          const isActive = metric === starsLbMetric;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
      }

      // Wire up Class Leaders filter buttons
      document.getElementById('slFilterAll')?.addEventListener('click', async () => {
        await loadStarsLeaderboard('all');
        updateStarsLbFilterUI();
        updateStarsMetricUI();
      });
      document.getElementById('slFilterMonth')?.addEventListener('click', async () => {
        await loadStarsLeaderboard('month');
        updateStarsLbFilterUI();
        updateStarsMetricUI();
      });
      // Refresh button for class leaderboard - force bypass server cache
      document.getElementById('slRefreshBtn')?.addEventListener('click', async () => {
        try {
          const userId = getCurrentUserId();
          const key = `${starsLbTimeframe}_${userId}`;
          starsLbCache.delete(key);
        } catch {}
        await loadStarsLeaderboard(starsLbTimeframe, true);
      });

      document.querySelectorAll('#starsLeaderboardTabs .lb-tab').forEach(btn => {
        btn.addEventListener('click', async () => {
          const metric = btn.getAttribute('data-metric');
          if (!metric || metric === starsLbMetric) return;
          starsLbMetric = metric;
          updateStarsMetricUI();
          try {
            const userId = getCurrentUserId();
            const key = `${starsLbTimeframe}_${userId}`;
            const cached = starsLbCache.get(key);
            if (cached) {
              renderStarsLeaderboard('starsLeaderboardContent', 'starsLeaderboardCard', cached, starsLbMetric);
              return;
            }
          } catch (e) { /* ignore */ }
          await loadStarsLeaderboard(starsLbTimeframe);
        });
      });

      // Fetch and render global leaderboard
      let globalLbTimeframe = 'month'; // 'all' | 'month' - default to month
      let globalLbMetric = 'super';
      const globalLbCache = new Map();

      async function loadGlobalLeaderboard(timeframe = globalLbTimeframe, forceRefresh = false) {
        const spinner = document.getElementById('globalSmallSpinner');
        const cacheKey = `lb_stars_global_${timeframe}`;
        globalLbTimeframe = timeframe;

        // Instant render from local cache (stale-while-revalidate)
        const local = getLbFromLocal(cacheKey);
        if (local && local.data && !forceRefresh) {
          globalLbCache.set(timeframe, local.data);
          renderGlobalLeaderboard('globalLeaderboardContent', 'globalLeaderboardCard', local.data, globalLbMetric);
          if (!local.stale) return; // Fresh enough, skip network
        }

        try {
          spinner?.classList.remove('hidden');
          // Use bypass_cache=1 when force refreshing to get fresh data from server
          const bypassParam = forceRefresh ? '&bypass_cache=1' : '';
          const url = `/api/progress_summary?section=leaderboard_stars_global&timeframe=${encodeURIComponent(timeframe)}${bypassParam}`;
          const r = await WillenaAPI.fetch(url);
          const data = await r.json();
          globalLbCache.set(timeframe, data);
          setLbToLocal(cacheKey, data);
          renderGlobalLeaderboard('globalLeaderboardContent', 'globalLeaderboardCard', data, globalLbMetric);
        } catch (err) {
          console.error('Global leaderboard error:', err);
          // Only show error if we have no cached data
          if (!local?.data) {
            const container = document.getElementById('globalLeaderboardContent');
            if (container) container.innerHTML = `<p style="color:#b00020;">${t('Failed to load')}</p>`;
          }
        } finally {
          spinner?.classList.add('hidden');
        }
      }

      function updateGlobalLbFilterUI() {
        const allBtn = document.getElementById('glFilterAll');
        const monBtn = document.getElementById('glFilterMonth');
        if (!allBtn || !monBtn) return;
        if (globalLbTimeframe === 'month') {
          monBtn.classList.add('active');
          monBtn.setAttribute('aria-pressed','true');
          allBtn.classList.remove('active');
          allBtn.setAttribute('aria-pressed','false');
        } else {
          allBtn.classList.add('active');
          allBtn.setAttribute('aria-pressed','true');
          monBtn.classList.remove('active');
          monBtn.setAttribute('aria-pressed','false');
        }
      }

      function updateGlobalMetricUI() {
        document.querySelectorAll('#globalLeaderboardTabs .lb-tab').forEach(btn => {
          const metric = btn.getAttribute('data-metric');
          const isActive = metric === globalLbMetric;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
      }

      // Wire up filter buttons
      document.getElementById('glFilterAll')?.addEventListener('click', async () => {
        await loadGlobalLeaderboard('all');
        updateGlobalLbFilterUI();
        updateGlobalMetricUI();
      });
      document.getElementById('glFilterMonth')?.addEventListener('click', async () => {
        await loadGlobalLeaderboard('month');
        updateGlobalLbFilterUI();
        updateGlobalMetricUI();
      });
      // Refresh button for global leaderboard - force bypass server cache
      document.getElementById('glRefreshBtn')?.addEventListener('click', async () => {
        // Clear local cache for this timeframe (scoped by user)
        clearLbLocalCache(`lb_stars_global_${globalLbTimeframe}`);
        globalLbCache.delete(globalLbTimeframe);
        await loadGlobalLeaderboard(globalLbTimeframe, true);
      });

      document.querySelectorAll('#globalLeaderboardTabs .lb-tab').forEach(btn => {
        btn.addEventListener('click', async () => {
          const metric = btn.getAttribute('data-metric');
          if (!metric || metric === globalLbMetric) return;
          globalLbMetric = metric;
          updateGlobalMetricUI();
          const cached = globalLbCache.get(globalLbTimeframe);
          if (cached) {
            renderGlobalLeaderboard('globalLeaderboardContent', 'globalLeaderboardCard', cached, globalLbMetric);
          } else {
            await loadGlobalLeaderboard(globalLbTimeframe);
          }
        });
      });

    // Check if user just logged in (flag set by login.html) - if so, force fresh data
    let forceInitialRefresh = false;
    try {
      const loginTs = localStorage.getItem('user_logged_in');
      const alreadyRefreshed = sessionStorage.getItem('lb_refreshed_after_login');
      
      if (loginTs && !alreadyRefreshed) {
        const loginAge = Date.now() - parseInt(loginTs, 10);
        if (loginAge < 60000) { // Within last 60 seconds
          // Login happened recently - force fresh data
          forceInitialRefresh = true;
          sessionStorage.setItem('lb_refreshed_after_login', '1'); // Mark as handled for this session
          console.log('[Dashboard] Fresh login detected, forcing leaderboard refresh');
        } else {
          // Old flag, clean it up
          localStorage.removeItem('user_logged_in');
        }
      }
    } catch (e) {
      console.warn('[Dashboard] Error checking login flag:', e);
    }

    // Initial load
    // Always force refresh for class leaderboard to ensure correct class after login switch
    await Promise.all([
      loadStarsLeaderboard(starsLbTimeframe, true),
      loadGlobalLeaderboard(globalLbTimeframe, forceInitialRefresh)
    ]);
    updateStarsMetricUI();
    updateGlobalMetricUI();

    // Update "This Month" buttons to show current month name
    function updateMonthButtons() {
      const monthName = new Date().toLocaleString(window.currentLang || 'en', { month: 'long' });
      ['slFilterMonth', 'glFilterMonth'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.textContent = monthName;
      });
    }
    updateMonthButtons();

      // Re-translate on language change
      window.addEventListener('studentlang:changed', async () => {
        starsLbCache.clear();
        globalLbCache.clear();
        // Clear local storage caches too (user-scoped)
        ['lb_stars_class_month', 'lb_stars_class_all', 'lb_stars_global_month', 'lb_stars_global_all'].forEach(k => clearLbLocalCache(k));
        await Promise.all([loadStarsLeaderboard(starsLbTimeframe, true), loadGlobalLeaderboard(globalLbTimeframe, true)]);
        updateStarsMetricUI();
        updateGlobalMetricUI();
        updateMonthButtons(); // Update month name for new language
      });
      // If auth changes in another tab or via explicit event, reload data to reflect new account
      window.addEventListener('auth:changed', () => {
        try {
          starsLbCache.clear();
          globalLbCache.clear();
          // Clear local storage caches on auth change (user-scoped keys will be different after reload anyway)
          ['lb_stars_class_month', 'lb_stars_class_all', 'lb_stars_global_month', 'lb_stars_global_all'].forEach(k => clearLbLocalCache(k));
        } catch {}
        // Simple full reload ensures all components (header, homework, leaderboards) reinitialize
        try { location.reload(); } catch { /* ignore */ }
      });

      // Also listen for storage updates (login/logout in other tabs) and reload when identity keys change
      window.addEventListener('storage', (e) => {
        try {
          if (!e || !e.key) return;
          if (["user_name","user_id","selectedEmojiAvatar"].includes(e.key)) {
            // Reload to pick up new auth/profile and refresh leaderboards/homework
            try { location.reload(); } catch {}
          }
        } catch {}
      });
    })();
  </script>

  <style>
    /* Leaderboard container */
    #starsLeaderboardCard .card-content,
    #globalLeaderboardCard .card-content {
      background: #2a3138;
      border-radius: 12px;
      padding: 16px !important;
      height: auto; /* allow dynamic growth when 6 entries (top 5 + self) */
      min-height: 120px;
    }

    html.dark #starsLeaderboardCard .card-content,
    html.dark #globalLeaderboardCard .card-content {
      background: #1f252d;
    }

    /* Simple text button styles for Willena Leaders filters */
    #globalLeaderboardFilters { display:flex; justify-content:center; gap:16px; align-items:center; }
    .gl-filter-btn {
      background: transparent;
      border: none;
      color: #8ea0b3;
      font-size: 0.95rem;
      cursor: pointer;
      padding: 4px 0;
    }
    .gl-filter-btn:hover { color: #cfe7ff; }
    .gl-filter-btn.active { color: #ffffff; font-weight: 600; text-decoration: underline; text-underline-offset: 3px; }

    /* Simple text button styles for Class Leaders filters */
    #starsLeaderboardFilters { display:flex; justify-content:center; gap:16px; align-items:center; }
    .sl-filter-btn {
      background: transparent;
      border: none;
      color: #8ea0b3;
      font-size: 0.95rem;
      cursor: pointer;
      padding: 4px 0;
    }
    .sl-filter-btn:hover { color: #cfe7ff; }
    .sl-filter-btn.active { color: #ffffff; font-weight: 600; text-decoration: underline; text-underline-offset: 3px; }

    /* Leaderboard metric tabs */
    .lb-tabs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      background: #1f252d;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      margin: 0 auto 12px auto;
      position: relative;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 6px rgba(0, 0, 0, 0.25);
      width: min(100%, 360px);
    }

    .lb-tab {
      background: transparent;
      border: none;
      color: #92a8bf;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      padding: 8px 18px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      flex: 1 1 100px;
      text-align: center;
    }

    .lb-tab:hover {
      color: #e6f6ff;
      transform: translateY(-1px);
    }

    .lb-tab.active {
      background: linear-gradient(135deg, #7ce2e6, #39b3c9);
      color: #0b1724;
      box-shadow: 0 4px 14px rgba(103, 226, 230, 0.35);
    }

    .lb-tab:focus-visible {
      outline: 2px solid #67e2e6;
      outline-offset: 2px;
    }

  /* Leaderboard styles */
    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 0;
      background: transparent;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.2s;
    }

    .leaderboard-item:last-child {
      border-bottom: none;
    }

    .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .leaderboard-item.self {
      background: transparent;
    }

    /* Glow effects - gold, silver, bronze for top 3 */
    .leaderboard-item[data-rank="1"] .player-name {
      text-shadow: 0 0px 5px #c9a961, 0 0px 16px #ffd700;
    }

    .leaderboard-item[data-rank="2"] .player-name {
      text-shadow: 0 0px 5px #c0c0c0, 0 0px 16px #e8e8e8;
    }

    .leaderboard-item[data-rank="3"] .player-name {
      text-shadow: 0 0px 5px #cd7f32, 0 0px 16px #e09755;
    }

    .rank-badge {
      font-size: 1.5rem;
      min-width: 50px;
      text-align: center;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .rank-medal {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border: 2px solid #3a4248;
      border-radius: 50%;
      padding: 4px;
      background: #1a1f26;
    }

    .player-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .player-name {
      font-family: 'Poppins', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      letter-spacing: 0.3px;
    }

    .player-class {
      font-size: 0.8rem;
      color: #aaa;
      font-weight: 400;
      font-family: 'Poppins', sans-serif;
    }

    .you-badge {
      padding: 0;
      background: transparent;
      color: #9a9c9c;
      border-radius: 0;
      font-size: 0.9em;
      font-weight: bold;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .player-metric {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      text-align: right;
      min-width: 110px;
    }

    .metric-primary {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1.05rem;
      color: #f8fbff;
      white-space: nowrap;
    }

    .metric-secondary {
      font-family: 'Poppins', sans-serif;
      font-size: 0.85rem;
      color: #8ea0b3;
    }

    .metric-stars {
      color: #ffd86f;
      text-shadow: 0 0 8px rgba(255, 214, 102, 0.45);
    }

    .metric-points {
      color: #67e2e6;
      text-shadow: 0 0 8px rgba(103, 226, 230, 0.35);
    }

    .metric-super {
      color: #ff9df4;
      text-shadow: 0 0 10px rgba(255, 157, 244, 0.45);
    }

    html.dark .metric-secondary {
      color: #9fb1c6;
    }

    @media (max-width: 460px) {
      .lb-tabs {
        width: 100%;
        padding: 6px;
        gap: 6px;
      }

      .lb-tab {
        flex: 1 1 calc(33.333% - 8px);
        padding: 8px 10px;
        font-size: 0.8rem;
      }

      .leaderboard-item {
        gap: 8px;
        padding: 12px 0;
      }

      .rank-badge {
        font-size: 1.25rem;
        min-width: 42px;
      }

      .rank-medal {
        width: 34px;
        height: 34px;
        padding: 3px;
      }

      .player-name {
        font-size: 1rem;
      }

      .player-info {
        gap: 2px;
      }

      .player-metric {
        min-width: auto;
        align-items: flex-end;
      }

      .metric-primary {
        font-size: 0.95rem;
      }

      .metric-secondary {
        font-size: 0.75rem;
      }
    }

    /* Dark mode adjustments */
    html.dark .leaderboard-item {
      border-bottom-color: rgba(255, 255, 255, 0.08);
    }

    html.dark .player-name {
      color: white;
    }

    html.dark .player-class {
      color: #888;
    }

    /* Loading skeleton styles */
    .lb-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
    }

    /* Small inline spinner used next to month/all filters */
    .mini-lb-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(103, 226, 230, 0.12);
      border-top-color: #67e2e6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    .mini-lb-spinner.hidden { display: none; }

    .lb-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(103, 226, 230, 0.1);
      border-top-color: #67e2e6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .lb-loading-text {
      font-size: 0.9rem;
      color: #8ea0b3;
      font-weight: 500;
    }

    .lb-skeleton-list {
      list-style: none;
      padding: 0;
      margin: 16px 0 0 0;
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lb-skel-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 0.3; }
    }

    .lb-skel-rank {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 50%;
      flex-shrink: 0;
    }

    .lb-skel-text {
      flex: 1;
      height: 18px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 4px;
             }

    .lb-skel-score {
      width: 80px;
      height: 18px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 4px;
      flex-shrink: 0;
    }

    html.dark .lb-skel-rank,
    html.dark .lb-skel-text,
    html.dark .lb-skel-score {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Homework card container style */
    .card-content.homework-scroll {
      background: #23272b !important;
      border-radius: 12px;
      padding: 16px !important;
      /* Custom scrollbar */
      scrollbar-color: #22d3ee #23272b;
    }
    .card-content.homework-scroll::-webkit-scrollbar {
      width: 2px;
      background: #23272b;
      border-radius: 2px;
    }
    .card-content.homework-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #22d3ee 0%, #23272b 100%);
      border-radius: 2px;
    }

    /* Hide homework container by default until assignments are loaded */
    #homeworkCard {
      display: none;
    }

    /* Animated glow effect for homework alert */
    .homework-glow {
      color: #fff;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      font-size: 1.25rem;
      text-shadow: 0 0 4px #ff69b4, 0 0 10px #ffd6f7;
      animation: glowPulse 1.8s infinite alternate;
    }
    @keyframes glowPulse {
      0% {
        text-shadow: 0 0 2px #ff69b4, 0 0 6px #ffd6f7;
      }
      100% {
        text-shadow: 0 0 8px #ff69b4, 0 0 18px #ffd6f7;
      }
    }
  </style>
</body>
</html>
