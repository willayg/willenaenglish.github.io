<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>get_audio_urls Migration Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d9ff; }
    .section {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h2 {
      margin-top: 0;
      color: #00d9ff;
      border-bottom: 1px solid #0f3460;
      padding-bottom: 10px;
    }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    input, textarea, select, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #0f3460;
      border-radius: 8px;
      background: #0f3460;
      color: #eee;
      font-size: 14px;
    }
    input:focus, textarea:focus { outline: 2px solid #00d9ff; }
    button {
      background: linear-gradient(135deg, #00d9ff, #0095ff);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.1s;
    }
    button:hover { transform: scale(1.02); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .result-box {
      background: #0f3460;
      border-radius: 8px;
      padding: 15px;
    }
    .result-box h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #aaa;
    }
    .result-box.netlify h3 { color: #00ad9f; }
    .result-box.cloudflare h3 { color: #f48120; }
    .result-box pre {
      background: #1a1a2e;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status.success { background: #00ad9f; color: #000; }
    .status.error { background: #ff4757; color: #fff; }
    .status.pending { background: #ffa502; color: #000; }
    .metrics {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    .metric {
      background: #1a1a2e;
      padding: 10px 15px;
      border-radius: 8px;
    }
    .metric-value { font-size: 24px; font-weight: 700; }
    .metric-label { font-size: 12px; color: #888; }
    .comparison {
      margin-top: 20px;
      padding: 15px;
      background: #0f3460;
      border-radius: 8px;
    }
    .match { color: #00ad9f; }
    .mismatch { color: #ff4757; }
    .config-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .warning {
      background: #ffa50233;
      border: 1px solid #ffa502;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .warning h4 { margin: 0 0 8px 0; color: #ffa502; }
  </style>
</head>
<body>
  <h1>üîÑ get_audio_urls Migration Test</h1>
  <p>Compare Netlify Function vs Cloudflare Worker responses side-by-side</p>

  <div class="warning">
    <h4>‚ö†Ô∏è Before Testing</h4>
    <ol style="margin: 0; padding-left: 20px;">
      <li>Deploy the CF Worker: <code>cd cloudflare-workers/get-audio-urls && npx wrangler deploy</code></li>
      <li>Update the R2 bucket name in <code>wrangler.toml</code> if different</li>
      <li>Set R2_PUBLIC_BASE secret: <code>npx wrangler secret put R2_PUBLIC_BASE</code> (optional)</li>
      <li>Copy the worker URL (e.g., <code>https://get-audio-urls.YOUR-SUBDOMAIN.workers.dev</code>)</li>
    </ol>
  </div>

  <div class="section">
    <h2>‚öôÔ∏è Configuration</h2>
    <div class="config-row">
      <div>
        <label for="netlifyUrl">Netlify Function URL</label>
        <input type="text" id="netlifyUrl" value="https://willenaenglish.netlify.app/.netlify/functions/get_audio_urls">
      </div>
      <div>
        <label for="cloudflareUrl">Cloudflare Worker URL</label>
        <input type="text" id="cloudflareUrl" placeholder="https://get-audio-urls.YOUR-SUBDOMAIN.workers.dev">
      </div>
    </div>
    <label for="testWords">Test Words (comma-separated)</label>
    <textarea id="testWords" rows="3">apple, banana, cat, dog, elephant, fish, grape, hello, ice, jump</textarea>
  </div>

  <div class="section">
    <h2>üß™ Run Test</h2>
    <button id="runTest" onclick="runComparison()">Run Comparison Test</button>
    <button id="runBoth" onclick="runBothSequential()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
      Run 10x Latency Test
    </button>
  </div>

  <div class="results-grid">
    <div class="result-box netlify">
      <h3>NETLIFY FUNCTION</h3>
      <div id="netlifyStatus"></div>
      <div class="metrics" id="netlifyMetrics"></div>
      <pre id="netlifyResult">Click "Run Comparison Test" to start</pre>
    </div>
    <div class="result-box cloudflare">
      <h3>CLOUDFLARE WORKER</h3>
      <div id="cloudflareStatus"></div>
      <div class="metrics" id="cloudflareMetrics"></div>
      <pre id="cloudflareResult">Click "Run Comparison Test" to start</pre>
    </div>
  </div>

  <div class="section comparison" id="comparisonSection" style="display: none;">
    <h2>üìä Comparison Results</h2>
    <div id="comparisonResult"></div>
  </div>

  <div class="section" id="latencySection" style="display: none;">
    <h2>üìà Latency Comparison (10 runs)</h2>
    <div class="results-grid">
      <div class="result-box netlify">
        <h3>NETLIFY LATENCIES</h3>
        <div id="netlifyLatencies"></div>
      </div>
      <div class="result-box cloudflare">
        <h3>CLOUDFLARE LATENCIES</h3>
        <div id="cloudflareLatencies"></div>
      </div>
    </div>
  </div>

  <script>
    async function callEndpoint(url, words) {
      const start = performance.now();
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ words }),
          credentials: 'include'
        });
        const data = await response.json();
        const duration = Math.round(performance.now() - start);
        return {
          success: response.ok,
          status: response.status,
          data,
          duration,
          error: null
        };
      } catch (err) {
        const duration = Math.round(performance.now() - start);
        return {
          success: false,
          status: 0,
          data: null,
          duration,
          error: err.message
        };
      }
    }

    function setStatus(elementId, success, text) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<span class="status ${success ? 'success' : 'error'}">${text}</span>`;
    }

    function setMetrics(elementId, duration, count) {
      const el = document.getElementById(elementId);
      el.innerHTML = `
        <div class="metric">
          <div class="metric-value">${duration}ms</div>
          <div class="metric-label">Response Time</div>
        </div>
        <div class="metric">
          <div class="metric-value">${count}</div>
          <div class="metric-label">Words Checked</div>
        </div>
      `;
    }

    function getWords() {
      return document.getElementById('testWords').value
        .split(',')
        .map(w => w.trim())
        .filter(w => w.length > 0);
    }

    async function runComparison() {
      const netlifyUrl = document.getElementById('netlifyUrl').value;
      const cloudflareUrl = document.getElementById('cloudflareUrl').value;
      const words = getWords();

      if (!cloudflareUrl) {
        alert('Please enter the Cloudflare Worker URL');
        return;
      }

      // Reset UI
      document.getElementById('netlifyResult').textContent = 'Loading...';
      document.getElementById('cloudflareResult').textContent = 'Loading...';
      document.getElementById('netlifyStatus').innerHTML = '<span class="status pending">Pending</span>';
      document.getElementById('cloudflareStatus').innerHTML = '<span class="status pending">Pending</span>';
      document.getElementById('comparisonSection').style.display = 'none';

      // Run both in parallel
      const [netlifyRes, cloudflareRes] = await Promise.all([
        callEndpoint(netlifyUrl, words),
        callEndpoint(cloudflareUrl, words)
      ]);

      // Display Netlify results
      setStatus('netlifyStatus', netlifyRes.success, netlifyRes.success ? `‚úì ${netlifyRes.status} OK` : `‚úó ${netlifyRes.status} Error`);
      setMetrics('netlifyMetrics', netlifyRes.duration, words.length);
      document.getElementById('netlifyResult').textContent = JSON.stringify(netlifyRes.data || netlifyRes.error, null, 2);

      // Display Cloudflare results
      setStatus('cloudflareStatus', cloudflareRes.success, cloudflareRes.success ? `‚úì ${cloudflareRes.status} OK` : `‚úó ${cloudflareRes.status} Error`);
      setMetrics('cloudflareMetrics', cloudflareRes.duration, words.length);
      document.getElementById('cloudflareResult').textContent = JSON.stringify(cloudflareRes.data || cloudflareRes.error, null, 2);

      // Compare results
      if (netlifyRes.success && cloudflareRes.success) {
        compareResults(netlifyRes.data, cloudflareRes.data, words);
      }
    }

    function compareResults(netlify, cloudflare, words) {
      const section = document.getElementById('comparisonSection');
      const result = document.getElementById('comparisonResult');
      section.style.display = 'block';

      const nResults = netlify?.results || {};
      const cResults = cloudflare?.results || {};

      let matches = 0;
      let mismatches = [];

      for (const word of words) {
        const nExists = nResults[word]?.exists;
        const cExists = cResults[word]?.exists;
        if (nExists === cExists) {
          matches++;
        } else {
          mismatches.push({ word, netlify: nExists, cloudflare: cExists });
        }
      }

      let html = `
        <p><strong>Total Words:</strong> ${words.length}</p>
        <p class="match"><strong>Matches:</strong> ${matches} ‚úì</p>
      `;

      if (mismatches.length > 0) {
        html += `<p class="mismatch"><strong>Mismatches:</strong> ${mismatches.length} ‚úó</p>`;
        html += '<ul>';
        for (const m of mismatches) {
          html += `<li><code>${m.word}</code>: Netlify=${m.netlify}, Cloudflare=${m.cloudflare}</li>`;
        }
        html += '</ul>';
      } else {
        html += `<p class="match"><strong>üéâ All results match! Safe to migrate.</strong></p>`;
      }

      result.innerHTML = html;
    }

    async function runBothSequential() {
      const netlifyUrl = document.getElementById('netlifyUrl').value;
      const cloudflareUrl = document.getElementById('cloudflareUrl').value;
      const words = getWords();

      if (!cloudflareUrl) {
        alert('Please enter the Cloudflare Worker URL');
        return;
      }

      document.getElementById('latencySection').style.display = 'block';
      const netlifyEl = document.getElementById('netlifyLatencies');
      const cloudflareEl = document.getElementById('cloudflareLatencies');
      netlifyEl.innerHTML = 'Running...';
      cloudflareEl.innerHTML = 'Running...';

      const netlifyTimes = [];
      const cloudflareTimes = [];

      for (let i = 0; i < 10; i++) {
        const [nRes, cRes] = await Promise.all([
          callEndpoint(netlifyUrl, words),
          callEndpoint(cloudflareUrl, words)
        ]);
        netlifyTimes.push(nRes.duration);
        cloudflareTimes.push(cRes.duration);

        // Update UI progressively
        netlifyEl.innerHTML = netlifyTimes.map((t, j) => `Run ${j + 1}: ${t}ms`).join('<br>');
        cloudflareEl.innerHTML = cloudflareTimes.map((t, j) => `Run ${j + 1}: ${t}ms`).join('<br>');
      }

      const nAvg = Math.round(netlifyTimes.reduce((a, b) => a + b, 0) / netlifyTimes.length);
      const cAvg = Math.round(cloudflareTimes.reduce((a, b) => a + b, 0) / cloudflareTimes.length);
      const nMin = Math.min(...netlifyTimes);
      const cMin = Math.min(...cloudflareTimes);
      const nMax = Math.max(...netlifyTimes);
      const cMax = Math.max(...cloudflareTimes);

      netlifyEl.innerHTML += `<hr><strong>Avg: ${nAvg}ms | Min: ${nMin}ms | Max: ${nMax}ms</strong>`;
      cloudflareEl.innerHTML += `<hr><strong>Avg: ${cAvg}ms | Min: ${cMin}ms | Max: ${cMax}ms</strong>`;

      const savings = nAvg - cAvg;
      const pct = Math.round((savings / nAvg) * 100);
      if (savings > 0) {
        cloudflareEl.innerHTML += `<br><span class="match">üöÄ ${pct}% faster (${savings}ms saved)</span>`;
      } else {
        netlifyEl.innerHTML += `<br><span class="match">Netlify is ${-pct}% faster</span>`;
      }
    }
  </script>
</body>
</html>
