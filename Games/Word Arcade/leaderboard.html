<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Live Leaderboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
:root { --accent:#67e2e6; --bg:#0f172a; }
* { box-sizing:border-box; }
body { margin:0; font-family:Poppins,system-ui,sans-serif; background:var(--bg); color:#fff; overflow:hidden; }
header { padding:18px 28px 6px; display:flex; align-items:center; justify-content:space-between; }
header h1 { margin:0; font-size:clamp(1.8rem,4vw,3.4rem); color:var(--accent); font-weight:800; letter-spacing:.5px; }
#updatedAt { font-size:.75rem; letter-spacing:.5px; color:#94a3b8; margin-left:14px; }
#controls { display:flex; gap:10px; }
button { font-family:inherit; font-weight:700; cursor:pointer; }
#listWrap { position:absolute; inset:90px 0 0 0; padding:0 24px 40px; display:flex; flex-direction:column; gap:10px; overflow:auto; scrollbar-width:thin; }
#listWrap::-webkit-scrollbar { width:10px; }
#listWrap::-webkit-scrollbar-track { background:#142132; }
#listWrap::-webkit-scrollbar-thumb { background:#23425a; border-radius:20px; }
.tlb-row { display:flex; align-items:center; gap:14px; padding:10px 18px; border-radius:18px; background:linear-gradient(90deg,#132033,#0f172a); position:relative; will-change:transform; }
.tlb-row:nth-child(odd){ background:linear-gradient(90deg,#182a42,#0f172a); }
.tlb-rank { font-size:clamp(1.05rem,1.5vw,2rem); font-weight:800; color:var(--accent); width:3.2ch; text-align:right; }
.tlb-medal { font-size:clamp(1.35rem,2vw,2.3rem); width:2.6ch; text-align:center; filter:drop-shadow(0 2px 4px rgba(0,0,0,.35)); }
.tlb-name { flex:1; font-size:clamp(1.05rem,2vw,2.35rem); font-weight:700; color:#fff; line-height:1.12; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.tlb-score { font-size:clamp(1.3rem,2.3vw,2.8rem); font-weight:900; color:#ffe082; display:flex; align-items:center; gap:10px; }
.tlb-up,.tlb-down { font-size:clamp(.68rem,.9vw,1.05rem); font-weight:700; padding:3px 9px; border-radius:22px; line-height:1; letter-spacing:.5px; }
.tlb-up { background:#065f46; color:#fff; }
.tlb-down { background:#7f1d1d; color:#fff; }
@keyframes tlbPulse { 0%,100% { box-shadow:0 0 0 0 rgba(103,226,230,0.55);} 50% { box-shadow:0 0 0 14px rgba(103,226,230,0);} }
@keyframes tlbBump { 0% { transform:scale(1);} 40% { transform:scale(1.07);} 100% { transform:scale(1);} }
.tlb-score.bump { animation:tlbBump .5s ease; }
.tlb-row.promoted { outline:2px solid var(--accent); animation:tlbPulse 2.4s ease 0.3s; }
.tlb-row.demoted { opacity:.9; }
.tlb-empty { color:#fff; font-size:1.5rem; font-weight:600; opacity:.75; padding:30px 10px; }
#status { position:fixed; bottom:6px; right:10px; font-size:.65rem; letter-spacing:.8px; color:#64748b; font-weight:600; }
#calmToggle { background:#142c3d; color:#cbd5e1; border:2px solid #23425a; padding:8px 14px; border-radius:14px; font-size:.8rem; }
#calmToggle.active { background:#23425a; color:#fff; }
#closeWin { background:#fff; color:#0f172a; border:2px solid var(--accent); padding:8px 14px; border-radius:14px; font-size:.8rem; }
/* QR Panel */
#qrToggle { background:#23425a; color:#fff; border:2px solid #355d78; padding:8px 14px; border-radius:14px; font-size:.8rem; }
#qrToggle.active { background:#355d78; }
#qrPanel { position:fixed; bottom:18px; right:18px; width:360px; background:#132033; border:2px solid #23425a; border-radius:18px; padding:12px 12px 14px; display:flex; flex-direction:column; gap:8px; box-shadow:0 10px 26px -4px rgba(0,0,0,.45); font-family:Poppins,system-ui,sans-serif; }
#qrPanel h2 { margin:0; font-size:.8rem; letter-spacing:.8px; font-weight:800; color:#67e2e6; text-align:center; }
#qrImg { width:320px; height:320px; border-radius:12px; background:#0f172a; border:2px solid #23425a; object-fit:cover; align-self:center; }
#qrLinkBox { font-size:.55rem; line-height:1.2; word-break:break-all; background:#0f172a; padding:6px 7px; border-radius:8px; border:1px solid #23425a; color:#cbd5e1; max-height:60px; overflow:auto; }
#qrActions { display:flex; gap:6px; }
#qrActions button, #qrActions a { flex:1; background:#19777e; color:#fff; border:none; padding:6px 8px; border-radius:8px; font-size:.6rem; font-weight:700; text-align:center; text-decoration:none; }
#qrActions button.secondary { background:#0d9488; }
#qrStatus { font-size:.55rem; font-weight:600; letter-spacing:.5px; color:#94a3b8; min-height:10px; text-align:center; }
#qrCloseSmall { position:absolute; top:4px; right:6px; background:none; border:none; color:#94a3b8; font-size:1rem; line-height:1; cursor:pointer; font-weight:700; }
#qrProviderNote { font-size:.45rem; text-align:center; color:#64748b; }
@media (max-width: 900px){
  #qrPanel { position:static; width:auto; flex-direction:row; align-items:center; padding:10px; gap:12px; }
  #qrImg { width:120px; height:120px; }
  #qrLinkBox { flex:1; font-size:.55rem; max-height:80px; }
  #qrActions { flex-direction:column; width:90px; }
  body { overflow:auto; }
}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:flex-end;gap:12px;">
    <h1>Live Leaderboard</h1>
    <span id="updatedAt"></span>
  </div>
  <div id="controls">
    <button id="qrToggle" title="Show/hide join QR">Show QR</button>
    <button id="calmToggle" title="Toggle calm mode (less animation)">Calm Mode</button>
    <button id="closeWin" onclick="window.close()">Close</button>
  </div>
</header>
<div id="listWrap"></div>
<div id="status"></div>
<div id="qrPanel" style="display:none;">
  <button id="qrCloseSmall" aria-label="Hide QR">×</button>
  <h2>SCAN TO JOIN</h2>
  <img id="qrImg" alt="QR code" />
  <div id="qrLinkBox"></div>
  <div id="qrActions">
    <button id="qrCopy" class="secondary" title="Copy link">Copy</button>
    <a id="qrOpen" target="_blank" rel="noopener" title="Open link">Open</a>
  </div>
  <div id="qrStatus"></div>
  <div id="qrProviderNote">Auto-fallback providers</div>
</div>
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const sessionId = qs.get('id');
  const forcedMode = qs.get('mode') || 'time_battle';
  const listWrap = document.getElementById('listWrap');
  const updatedAt = document.getElementById('updatedAt');
  const status = document.getElementById('status');
  const calmToggle = document.getElementById('calmToggle');
  const qrToggle = document.getElementById('qrToggle');
  const qrPanel = document.getElementById('qrPanel');
  const qrImg = document.getElementById('qrImg');
  const qrLinkBox = document.getElementById('qrLinkBox');
  const qrCopy = document.getElementById('qrCopy');
  const qrOpen = document.getElementById('qrOpen');
  const qrStatus = document.getElementById('qrStatus');
  const qrCloseSmall = document.getElementById('qrCloseSmall');
  let calm = false;
  let prev = []; // { name, score, index }
  let prevKey = '';
  let active = true;
  let qrProvidersTried = 0;

  calmToggle.addEventListener('click', ()=>{ calm = !calm; calmToggle.classList.toggle('active', calm); });
  qrToggle.addEventListener('click', ()=>{ const show = qrPanel.style.display==='none'; qrPanel.style.display = show?'block':'none'; qrToggle.classList.toggle('active', show); if (show) ensureQr(); });
  qrCloseSmall.addEventListener('click', ()=>{ qrPanel.style.display='none'; qrToggle.classList.remove('active'); });

  function snapshotKey(list){ return list.map(e=>e.name+':'+e.score).join('|'); }
  function medal(i){ return i===0?'\uD83E\uDD47': i===1?'\uD83E\uDD48': i===2?'\uD83E\uDD49':''; }

  function buildRow(entry, i, prevIndex, scoreChanged){
    const up = prevIndex > i && prevIndex !== -1;
    const down = prevIndex < i && prevIndex !== -1;
    const delta = up? `<span class="tlb-up">▲ ${prevIndex - i}</span>` : down? `<span class="tlb-down">▼ ${i - prevIndex}</span>` : '';
    return `<div class="tlb-rank">${i+1}</div><div class="tlb-medal">${medal(i)}</div><div class="tlb-name">${(entry.name||'Player').replace(/</g,'&lt;')}</div><div class="tlb-score${scoreChanged?' bump':''}">${entry.score}${delta}</div>`;
  }

  async function poll(){
    if (!active || !sessionId) return;
    try {
      const url = new URL('/.netlify/functions/timer_score', location.origin);
      url.searchParams.set('session_id', sessionId);
      url.searchParams.set('best','1');
      url.searchParams.set('limit','50');
      const res = await fetch(url.toString(), { cache:'no-store' });
      const js = await res.json().catch(()=>null);
      if (js && js.success && Array.isArray(js.leaderboard)) update(js.leaderboard);
      status.textContent = '';
    } catch(e){ status.textContent = 'Network issue...'; }
    finally { setTimeout(poll, 3000); }
  }

  function update(entries){
    const top = entries.slice(0,50);
    const key = snapshotKey(top);
    if (key === prevKey) { updatedAt.textContent = new Date().toLocaleTimeString(); return; }

    // FIRST rects
    const first = new Map();
    listWrap.querySelectorAll('.tlb-row').forEach(r=> first.set(r.dataset.name, r.getBoundingClientRect()));

    const existing = new Map();
    listWrap.querySelectorAll('.tlb-row').forEach(r=> existing.set(r.dataset.name, r));
    const used = new Set();

    top.forEach((entry,i)=>{
      const name = entry.name || 'Player';
      let row = existing.get(name);
      const prevEntry = prev.find(p=>p.name===name);
      const prevIndex = prevEntry ? prevEntry.index : -1;
      const scoreChanged = !!(prevEntry && prevEntry.score !== entry.score);
      if (!row){
        row = document.createElement('div');
        row.className = 'tlb-row';
        row.dataset.name = name;
        row.innerHTML = buildRow(entry,i,prevIndex,scoreChanged);
        const ref = listWrap.children[i];
        if (ref) listWrap.insertBefore(row, ref); else listWrap.appendChild(row);
        row.style.opacity='0'; row.style.transform='translateY(12px)';
        requestAnimationFrame(()=>{ row.style.transition='opacity .4s ease, transform .45s ease'; row.style.opacity='1'; row.style.transform='translateY(0)'; });
      } else {
        if (prevIndex !== i){
          row.classList.remove('promoted','demoted');
          if (!calm){
            if (prevIndex > i && prevIndex !== -1) row.classList.add('promoted');
            else if (prevIndex < i && prevIndex !== -1) row.classList.add('demoted');
          }
        }
        row.innerHTML = buildRow(entry,i,prevIndex,scoreChanged);
        const ref = listWrap.children[i];
        if (ref !== row) listWrap.insertBefore(row, ref);
      }
      used.add(name);
    });

    // OUT: fade removed
    listWrap.querySelectorAll('.tlb-row').forEach(r=>{
      if (!used.has(r.dataset.name)){
        r.style.transition='opacity .35s ease, transform .35s ease';
        r.style.opacity='0'; r.style.transform='translateY(14px)';
        setTimeout(()=>r.remove(), 380);
      }
    });

    // LAST rects for FLIP
    const last = new Map();
    listWrap.querySelectorAll('.tlb-row').forEach(r=> last.set(r.dataset.name, r.getBoundingClientRect()));
    listWrap.querySelectorAll('.tlb-row').forEach(r=>{
      const f = first.get(r.dataset.name); const l = last.get(r.dataset.name); if(!f||!l) return;
      const dx = f.left - l.left; const dy = f.top - l.top; if (!dx && !dy) return;
      r.style.transition='none'; r.style.transform=`translate(${dx}px,${dy}px)`;
      requestAnimationFrame(()=>{ r.style.transition='transform .55s cubic-bezier(.22,.8,.26,.99)'; r.style.transform='translate(0,0)'; });
    });

    prev = top.map((e,i)=>({ name:e.name, score:e.score, index:i }));
    prevKey = key;
    updatedAt.textContent = new Date().toLocaleTimeString();
  }

  function buildJoinUrl(){
    if (!sessionId) return '';
    try {
      const u = new URL(location.origin + '/Games/Word Arcade/play.html');
      u.searchParams.set('id', sessionId);
      u.searchParams.set('mode', forcedMode);
      return u.toString();
    } catch { return ''; }
  }

  function ensureQr(){
    if (!sessionId || !qrImg) return;
    if (!qrImg.dataset.loaded){
      const link = buildJoinUrl();
      qrLinkBox.textContent = link;
      if (qrOpen) qrOpen.href = link;
      const providers = [
        `https://chart.googleapis.com/chart?cht=qr&chs=600x600&chld=M|0&chl=${encodeURIComponent(link)}`,
        `https://quickchart.io/qr?text=${encodeURIComponent(link)}&size=600&margin=0`,
        `https://api.qrserver.com/v1/create-qr-code/?size=600x600&data=${encodeURIComponent(link)}`
      ];
      let i=0; qrProvidersTried=0;
      const tryNext = ()=>{ if(i>=providers.length){ qrStatus.textContent='All providers failed'; return; } qrImg.src = providers[i++]; qrProvidersTried++; };
      qrImg.onload = ()=>{ qrImg.dataset.loaded='1'; qrStatus.textContent=''; };
      qrImg.onerror = ()=>{ qrStatus.textContent='Retrying...'; setTimeout(tryNext, 250); };
      tryNext();
      if (qrCopy) qrCopy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(link); qrCopy.textContent='Copied!'; setTimeout(()=>qrCopy.textContent='Copy',1600);}catch{} };
    }
  }

  if (!sessionId){ listWrap.innerHTML = '<div class="tlb-empty">No session id provided (?id=)</div>'; active=false; }
  else poll();
  // Auto-show QR on initial load for convenience
  if (sessionId) { qrPanel.style.display='block'; qrToggle.classList.add('active'); ensureQr(); }
})();
</script>
</body>
</html>
